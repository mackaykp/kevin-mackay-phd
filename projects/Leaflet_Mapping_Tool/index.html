<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Leaflet Mapping Tool – Kevin Mackay, PhD</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-4d9afe2b8d18ee9fa5d0d57b5ed4214d.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-3664daef4cec8c8f8c2c05a3425b7620.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-2269a16a10f40f9c63e4d931574e2d6a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-3664daef4cec8c8f8c2c05a3425b7620.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Kevin Mackay, PhD</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../what-i-do.html"> 
<span class="menu-text">What I Do</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html"> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../work-with-me.html"> 
<span class="menu-text">Work With Me</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mackaykp/kevin-mackay-phd"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/kevin-mackay-phd/"> <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Leaflet Mapping Tool</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="yoga-view-toggle" role="group" aria-label="Switch view">
<button type="button" class="btn btn-primary yoga-btn-product" aria-pressed="true">
Final product
</button>
<button type="button" class="btn btn-outline-primary yoga-btn-overview" aria-pressed="false">
Project Overview
</button>
<button type="button" class="btn btn-outline-primary yoga-btn-scripts" aria-pressed="false">
Scripts &amp; Code
</button>
</div>
<div id="yoga-final-product" class="yoga-view-panel">
<div class="yoga-embed-bar">
<p><a href="vignettes/vignettes.html" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">Open mapping tool in new tab</a></p>
</div>
<div id="yoga-iframe-wrap" class="yoga-embed-full">
<iframe src="vignettes/vignettes.html" title="Leaflet Mapping Tool — vignettes" class="yoga-embed" allowfullscreen="" style="width:100%;height:100%;position:absolute;left:0;top:0;border:0;">
</iframe>
</div>
</div>
<div id="yoga-overview" class="yoga-view-panel d-none">
<section id="problem" class="level2">
<h2 class="anchored" data-anchor-id="problem">Problem</h2>
<p>A Statistics Canada field team needed a way to identify safe areas to stay while conducting months‑long data collection in cities across Canada. For each of the 16 survey cities, they required:<br>
</p>
<ul>
<li>maps detailed enough to show building‑level satellite imagery</li>
<li>50+ static maps per city to cover different neighbourhoods and safety considerations</li>
<li>a solution that could be updated every two years and used by staff without GIS expertise The existing approach (i.e., manually producing dozens of static maps) was time‑consuming, difficult to maintain, and not reproducible by the client’s team.</li>
</ul>
</section>
<section id="approach" class="level2">
<h2 class="anchored" data-anchor-id="approach">Approach</h2>
<p>To address the scale and complexity of the request, I designed an interactive mapping tool using OpenStreetMap data and R. This approach allowed me to:<br>
</p>
<ul>
<li>replace hundreds of static maps with a single, dynamic map per city</li>
<li>incorporate zooming, panning, basemap switching, and layer toggling</li>
<li>allow users to click features to reveal additional information</li>
<li>build a workflow that could be run by non‑GIS staff with basic R skills The tool automated data retrieval, processing, and map generation, making it adaptable to any Canadian city—and scalable beyond Canada if needed.</li>
</ul>
</section>
<section id="impact" class="level2">
<h2 class="anchored" data-anchor-id="impact">Impact</h2>
<ul>
<li>Reduced 50+ maps per city to one interactive map, improving usability and reducing cognitive load for field teams.</li>
<li>Eliminated dependency on GIS specialists, enabling analysts with basic R skills to generate maps independently.</li>
<li>Created a future‑proof workflow that can be reused every two years for recurring surveys and adapted for other Statistics Canada programs.</li>
<li>Improved consistency and reproducibility, ensuring that all cities follow the same mapping logic and data standards.</li>
</ul>
</section>
<section id="note" class="level2">
<h2 class="anchored" data-anchor-id="note">Note</h2>
<p>Because safety and crime data are not publicly available, the public version of this tool demonstrates its capabilities using median household income and access to greenspace. The underlying workflow remains the same, and I’ve also extended the tool to support bivariate mapping to showcase its flexibility. If you’re interested in adapting this tool for your own project, feel free to reach out - I’m happy to help!</p>
</section>
</div>
<div id="yoga-scripts" class="yoga-view-panel d-none">
<section id="script-create-bivariate-map" class="level2">
<h2 class="anchored" data-anchor-id="script-create-bivariate-map">create_bivariate_map.R</h2>
<p><strong>What it does:</strong> Main entry point for the bivariate map. Builds an <strong>Income × Green area per 1,000 people</strong> Leaflet map for a given city or custom bbox. Sources map_config, process_bbox, and process_green_da; clips DAs to the study area, fetches OSM greenspace (with optional walkable buffer), classifies income and greenspace into Low/Med/High (mean ± 1 SD), and renders a 3×3 bivariate choropleth with popups and legend. Supports custom_bbox, custom_distance_km, green_buffer_m, and show_green_layers.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Bivariate map: Income × Green area per 1000 people (greenspace within walkable buffer). 3 classes each (±1 SD), 9 colours.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Income = median total income of household (2020 $); classified Low/Med/High by study-area mean ± 1 SD.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: income GeoPackage (e.g. data/ses_index.gpkg from build_ses_index.R or data/income.gpkg) with 'population' and 'income_raw'; process_bbox is called automatically if needed.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage: source("R/create_bivariate_map.R"); create_bivariate_map(city = "Halifax, NS", income_gpkg = "data/ses_index.gpkg")</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Popup: Income (median household $), Income Category, Greenspace (area, population, per 1000, category), Description.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">dir.exists</span>(<span class="st">"R"</span>)) {</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"R/map_config.R"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"R/process_bbox.R"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"R/process_green_da.R"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"map_config.R"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"process_bbox.R"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"process_green_da.R"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmltools)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmlwidgets)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 3x3 bivariate palette: Income × Green area (user-specified)</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>BIVAR_COLOURS <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"#F3F3F3"</span>, <span class="st">"#C2F1CE"</span>, <span class="st">"#8BE2AF"</span>,   <span class="co"># Income Low  × Green Low, Med, High</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"#EAC5DD"</span>, <span class="st">"#9EC6D3"</span>, <span class="st">"#7FC6B1"</span>,   <span class="co"># Income Med  × Green Low, Med, High</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"#E6A3D0"</span>, <span class="st">"#BC9FCE"</span>, <span class="st">"#7B8EAF"</span>     <span class="co"># Income High × Green Low, Med, High</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(BIVAR_COLOURS) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Low-Low"</span>, <span class="st">"Low-Med"</span>, <span class="st">"Low-High"</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Med-Low"</span>, <span class="st">"Med-Med"</span>, <span class="st">"Med-High"</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"High-Low"</span>, <span class="st">"High-Med"</span>, <span class="st">"High-High"</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Bivariate category descriptions (row = Income, col = Greenspace)</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>BIVAR_DESCRIPTIONS <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Low-Low"</span>  <span class="ot">=</span> <span class="st">"Low income with limited greenspace access."</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Low-Med"</span>  <span class="ot">=</span> <span class="st">"Low income with moderate greenspace access."</span>,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Low-High"</span> <span class="ot">=</span> <span class="st">"Low income with high greenspace access."</span>,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Med-Low"</span>  <span class="ot">=</span> <span class="st">"Moderate income with low greenspace access."</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Med-Med"</span>  <span class="ot">=</span> <span class="st">"Moderate income with moderate greenspace access."</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Med-High"</span> <span class="ot">=</span> <span class="st">"Moderate income with high greenspace access."</span>,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"High-Low"</span> <span class="ot">=</span> <span class="st">"High income with low greenspace access."</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"High-Med"</span> <span class="ot">=</span> <span class="st">"High income with moderate greenspace access."</span>,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"High-High"</span><span class="ot">=</span> <span class="st">"High income with high greenspace access."</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert hex colour to rgba with given alpha (for legend transparency)</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>hex_to_rgba <span class="ot">&lt;-</span> <span class="cf">function</span>(hex, <span class="at">alpha =</span> <span class="fl">0.6</span>) {</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">strtoi</span>(<span class="fu">substr</span>(hex, <span class="dv">2</span>, <span class="dv">3</span>), <span class="dv">16</span>L)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">strtoi</span>(<span class="fu">substr</span>(hex, <span class="dv">4</span>, <span class="dv">5</span>), <span class="dv">16</span>L)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">strtoi</span>(<span class="fu">substr</span>(hex, <span class="dv">6</span>, <span class="dv">7</span>), <span class="dv">16</span>L)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sprintf</span>(<span class="st">"rgba(%d,%d,%d,%.2f)"</span>, r, g, b, alpha)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Build HTML for 3x3 legend: y-axis = Greenspace (dependent), x-axis = Income (independent).</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Grid: rows = Green High/Med/Low, cols = Income Low/Med/High. Colour at (green_row, income_col) = same (income, green) combo.</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>bivariate_legend_html <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">fill_alpha =</span> <span class="dv">1</span>) {</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># BIVAR_COLOURS indexed as (income_row, green_col); income_row 1=Low,2=Med,3=High; green_col 1=Low,2=Med,3=High.</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Legend rows = Green (1=High, 2=Med, 3=Low), cols = Income (1=Low, 2=Med, 3=High). So colour idx = (income_col - 1)*3 + (4 - green_row).</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  cell <span class="ot">&lt;-</span> <span class="cf">function</span>(green_row, income_col) {</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> (income_col <span class="sc">-</span> <span class="dv">1</span>L) <span class="sc">*</span> <span class="dv">3</span>L <span class="sc">+</span> (<span class="dv">4</span>L <span class="sc">-</span> green_row)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    col_rgba <span class="ot">&lt;-</span> <span class="fu">hex_to_rgba</span>(BIVAR_COLOURS[i], fill_alpha)</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">'&lt;div style="width:26px;height:26px;background:%s;border:1px solid #555;"&gt;&lt;/div&gt;'</span>, col_rgba)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  y_label_rotated <span class="ot">&lt;-</span> <span class="st">'&lt;div style="writing-mode:vertical-rl;transform:rotate(-180deg);font-size:9px;height:78px;line-height:1.35;text-align:center;"&gt;Green area per&lt;br&gt;1,000 people&lt;/div&gt;'</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">'&lt;tr&gt;&lt;td rowspan="3" style="vertical-align:middle;width:1px;padding:0 4px 0 0;"&gt;'</span>, y_label_rotated, <span class="st">'&lt;/td&gt;'</span>,</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>           <span class="st">'&lt;td style="text-align:right;padding-right:4px;font-size:9px;vertical-align:middle;"&gt;High&lt;/td&gt;'</span>,</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>           <span class="st">'&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="st">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="st">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="st">'&lt;/td&gt;&lt;/tr&gt;'</span>),</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">'&lt;tr&gt;&lt;td style="text-align:right;padding-right:4px;font-size:9px;vertical-align:middle;"&gt;Med&lt;/td&gt;'</span>,</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>           <span class="st">'&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">2</span>, <span class="dv">1</span>), <span class="st">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="st">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="st">'&lt;/td&gt;&lt;/tr&gt;'</span>),</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">'&lt;tr&gt;&lt;td style="text-align:right;padding-right:4px;font-size:9px;vertical-align:middle;"&gt;Low&lt;/td&gt;'</span>,</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>           <span class="st">'&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">3</span>, <span class="dv">1</span>), <span class="st">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">3</span>, <span class="dv">2</span>), <span class="st">'&lt;/td&gt;&lt;td&gt;'</span>, <span class="fu">cell</span>(<span class="dv">3</span>, <span class="dv">3</span>), <span class="st">'&lt;/td&gt;&lt;/tr&gt;'</span>),</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td style="text-align:center;font-size:9px;padding-top:2px;"&gt;Low&lt;/td&gt;&lt;td style="text-align:center;font-size:9px;padding-top:2px;"&gt;Med&lt;/td&gt;&lt;td style="text-align:center;font-size:9px;padding-top:2px;"&gt;High&lt;/td&gt;&lt;/tr&gt;'</span>,</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan="3" style="text-align:center;font-size:9px;padding-top:4px;line-height:1.35;"&gt;Median Household&lt;br&gt;Income&lt;/td&gt;&lt;/tr&gt;'</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;div class="leaflet-bivariate-legend" style="z-index:9999;position:relative;background:white;padding:10px;border-radius:4px;box-shadow:0 1px 5px rgba(0,0,0,0.3);max-width:260px;"&gt;'</span>,</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;div style="font-weight:bold;font-size:11px;margin-bottom:6px;"&gt;Exploring how median household income influences greenspace access by dissemination area, 2020&lt;/div&gt;'</span>,</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;div style="font-size:9px;margin-bottom:8px;line-height:1.35;"&gt;&lt;b&gt;Interpretation:&lt;/b&gt;&lt;br&gt;'</span>,</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;b&gt;Blues:&lt;/b&gt; Equal greenspace access to median household income.&lt;br&gt;'</span>,</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;b&gt;Greens:&lt;/b&gt; Equitable greenspace access for DAs with low median household income.&lt;br&gt;'</span>,</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;b&gt;Pinks:&lt;/b&gt; Low greenspace access for DAs with high median household income.&lt;/div&gt;'</span>,</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;table style="border-collapse:collapse;"&gt;&lt;tbody&gt;'</span>, <span class="fu">paste</span>(rows, <span class="at">collapse =</span> <span class="st">""</span>), <span class="st">'&lt;/tbody&gt;&lt;/table&gt;'</span>,</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="co"># For testing: write the bivariate legend to a standalone HTML file and optionally open it.</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage: source("R/create_bivariate_map.R"); preview_legend()</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit bivariate_legend_html() or BIVAR_COLOURS, then run preview_legend() again to refresh.</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>preview_legend <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">open =</span> <span class="cn">TRUE</span>, <span class="at">file =</span> <span class="st">"output/maps/legend_preview.html"</span>) {</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">dirname</span>(file), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>  html <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset='UTF-8'&gt;&lt;/head&gt;&lt;body style='margin:20px;'&gt;"</span>,</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bivariate_legend_html</span>(),</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"&lt;/body&gt;&lt;/html&gt;"</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(html, file)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Legend written to "</span>, <span class="fu">normalizePath</span>(file, <span class="at">mustWork =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (open) {</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"rstudioapi"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> rstudioapi<span class="sc">::</span><span class="fu">isAvailable</span>()) {</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>      rstudioapi<span class="sc">::</span><span class="fu">viewer</span>(file)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>      utils<span class="sc">::</span><span class="fu">browseURL</span>(file)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(file)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>create_bivariate_map <span class="ot">&lt;-</span> <span class="cf">function</span>(city, income_gpkg, <span class="at">amalgamation_cities_list =</span> <span class="cn">NULL</span>, <span class="at">city_pr =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">custom_bbox =</span> <span class="cn">NULL</span>, <span class="at">custom_distance_km =</span> <span class="dv">0</span>, <span class="at">green_buffer_m =</span> <span class="dv">500</span>,</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">show_green_layers =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># green_buffer_m: for each DA, greenspace is summed inside the DA plus within this distance (m) of the DA. Zone = DA + buffer (default 500 m).</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Step 1 of 5: Processing bounding box and clipping income layer..."</span>)</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>  expanded_bbox <span class="ot">&lt;-</span> <span class="fu">process_bbox</span>(</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">study_area =</span> city,</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">income_gpkg =</span> income_gpkg,</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">amalgamation_cities_list =</span> amalgamation_cities_list,</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">city_pr =</span> city_pr,</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">custom_bbox =</span> custom_bbox,</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">custom_distance_km =</span> custom_distance_km</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>  modified_text <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">str_extract</span>(city, <span class="st">"^[^,]+"</span>), <span class="st">" "</span>, <span class="st">"_"</span>)</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>  income_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">dirname</span>(income_gpkg), <span class="st">"clipped_income"</span>)</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>  city_income_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(income_dir, <span class="fu">paste0</span>(modified_text, <span class="st">".gpkg"</span>))</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(city_income_path)) <span class="fu">stop</span>(<span class="st">"Clipped income layer not found: "</span>, city_income_path, <span class="st">" Run process_bbox first (e.g. by running this function once with the same city)."</span>)</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>  city_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(city_income_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(city_shp) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No polygons in study area."</span>)</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"population"</span> <span class="sc">%in%</span> <span class="fu">names</span>(city_shp)) <span class="fu">stop</span>(<span class="st">"Clipped layer missing 'population'. Ensure income layer includes CHARACTERISTIC_ID 1 for total population."</span>)</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Step 2 of 5: Computing green area per DA (OSM, buffer "</span>, green_buffer_m, <span class="st">" m)..."</span>)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>  city_shp <span class="ot">&lt;-</span> <span class="fu">process_green_da</span>(city_shp, expanded_bbox, <span class="at">buffer_m =</span> green_buffer_m, <span class="at">city =</span> city)</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>  n_na_green <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(city_shp<span class="sc">$</span>green_area_per_1000))</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n_na_green <span class="sc">==</span> <span class="fu">nrow</span>(city_shp) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(city_shp) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Green area per 1,000 people is NA for all DAs. Likely cause: 'population' is missing or zero in the census. "</span>,</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Ensure your income layer includes CHARACTERISTIC_ID 1 (Total population), then process_bbox and this map."</span>,</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>      <span class="at">call. =</span> <span class="cn">FALSE</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prefer income_raw (median household $); fallback to ses_idx or index if present (e.g. from build_ses_index.R)</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>  idx_col <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">c</span>(<span class="st">"ses_idx"</span>, <span class="st">"income_raw"</span>, <span class="st">"index"</span>), <span class="fu">names</span>(city_shp))[<span class="dv">1</span>]</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(idx_col)) idx_col <span class="ot">&lt;-</span> <span class="fu">names</span>(city_shp)[<span class="fu">sapply</span>(city_shp, is.numeric)][<span class="dv">1</span>]</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>plot_income <span class="ot">&lt;-</span> city_shp[[idx_col]]</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"income_raw"</span> <span class="sc">%in%</span> <span class="fu">names</span>(city_shp)) {</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>    city_shp<span class="sc">$</span>plot_income[<span class="fu">is.na</span>(city_shp<span class="sc">$</span>income_raw)] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>  green_var <span class="ot">&lt;-</span> <span class="st">"green_area_per_1000"</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3 classes each: ±1 SD (Low &lt; mean - sd, High &gt; mean + sd, else Medium)</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>  mean_income   <span class="ot">&lt;-</span> <span class="fu">mean</span>(city_shp<span class="sc">$</span>plot_income, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>  sd_income     <span class="ot">&lt;-</span> <span class="fu">sd</span>(city_shp<span class="sc">$</span>plot_income, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>  mean_green <span class="ot">&lt;-</span> <span class="fu">mean</span>(city_shp[[green_var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>  sd_green   <span class="ot">&lt;-</span> <span class="fu">sd</span>(city_shp[[green_var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(sd_income) <span class="sc">||</span> sd_income <span class="sc">==</span> <span class="dv">0</span>) sd_income <span class="ot">&lt;-</span> <span class="fl">1e-9</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(sd_green) <span class="sc">||</span> sd_green <span class="sc">==</span> <span class="dv">0</span>) sd_green <span class="ot">&lt;-</span> <span class="fl">1e-9</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>  city_shp <span class="ot">&lt;-</span> city_shp <span class="sc">%&gt;%</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>      <span class="at">class_income   =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.na</span>(plot_income) <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>        plot_income <span class="sc">&lt;</span> mean_income <span class="sc">-</span> sd_income <span class="sc">~</span> <span class="st">"Low"</span>,</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>        plot_income <span class="sc">&gt;</span> mean_income <span class="sc">+</span> sd_income <span class="sc">~</span> <span class="st">"High"</span>,</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Med"</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>      <span class="at">class_green =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>        .data[[green_var]] <span class="sc">&lt;</span> mean_green <span class="sc">-</span> sd_green <span class="sc">~</span> <span class="st">"Low"</span>,</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>        .data[[green_var]] <span class="sc">&gt;</span> mean_green <span class="sc">+</span> sd_green <span class="sc">~</span> <span class="st">"High"</span>,</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Med"</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>      <span class="at">class_green =</span> <span class="fu">replace_na</span>(class_green, <span class="st">"Low"</span>),</span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>      <span class="at">bivar =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(class_income) <span class="sc">|</span> <span class="fu">is.na</span>(class_green), <span class="cn">NA_character_</span>,</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">paste</span>(class_income, class_green, <span class="at">sep =</span> <span class="st">"-"</span>))</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>bivar_colour <span class="ot">&lt;-</span> BIVAR_COLOURS[city_shp<span class="sc">$</span>bivar]</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>bivar_colour[<span class="fu">is.na</span>(city_shp<span class="sc">$</span>bivar_colour)] <span class="ot">&lt;-</span> <span class="st">"#CBCBCB"</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>bivar_opacity <span class="ot">&lt;-</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(city_shp<span class="sc">$</span>bivar), <span class="dv">0</span>, <span class="fl">0.6</span>)</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normal stroke for non-extreme DAs; inner stroke only for extreme (corner) DAs</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>  BIVAR_EXTREMES <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Low-Low"</span>, <span class="st">"High-High"</span>, <span class="st">"High-Low"</span>, <span class="st">"Low-High"</span>)</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>bivar_edge_color <span class="ot">&lt;-</span> <span class="fu">if_else</span>(</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(city_shp<span class="sc">$</span>bivar), <span class="st">"transparent"</span>,</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">if_else</span>(city_shp<span class="sc">$</span>bivar <span class="sc">%in%</span> BIVAR_EXTREMES, <span class="st">"#FFBB00"</span>, <span class="st">"white"</span>)</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>bivar_edge_weight <span class="ot">&lt;-</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(city_shp<span class="sc">$</span>bivar), <span class="dv">0</span>L, <span class="fu">if_else</span>(city_shp<span class="sc">$</span>bivar <span class="sc">%in%</span> BIVAR_EXTREMES, <span class="fl">1.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>polygon_stroke_color <span class="ot">&lt;-</span> <span class="fu">if_else</span>(</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(city_shp<span class="sc">$</span>bivar), <span class="st">"transparent"</span>,</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">if_else</span>(city_shp<span class="sc">$</span>bivar <span class="sc">%in%</span> BIVAR_EXTREMES, <span class="st">"transparent"</span>, <span class="st">"white"</span>)</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>  city_shp<span class="sc">$</span>polygon_stroke_weight <span class="ot">&lt;-</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(city_shp<span class="sc">$</span>bivar), <span class="dv">0</span>L, <span class="fu">if_else</span>(city_shp<span class="sc">$</span>bivar <span class="sc">%in%</span> BIVAR_EXTREMES, <span class="dv">0</span>L, <span class="fl">0.5</span>))</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>  bbox_polygon <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="fu">st_bbox</span>(<span class="fu">c</span>(</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin =</span> expanded_bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], <span class="at">ymin =</span> expanded_bbox[<span class="st">"y"</span>, <span class="st">"min"</span>],</span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmax =</span> expanded_bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], <span class="at">ymax =</span> expanded_bbox[<span class="st">"y"</span>, <span class="st">"max"</span>]</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>)))</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Step 3 of 5: Building Income × Greenspace map..."</span>)</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>  green_na <span class="ot">&lt;-</span> <span class="fu">is.na</span>(city_shp[[green_var]])</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>  fmt_km2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">format</span>(<span class="fu">round</span>(x <span class="sc">/</span> <span class="fl">1e6</span>, <span class="dv">1</span>), <span class="at">big.mark =</span> <span class="st">","</span>, <span class="at">nsmall =</span> <span class="dv">1</span>, <span class="at">trim =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>  fmt_pop <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">if_else</span>(<span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="sc">!</span><span class="fu">is.finite</span>(x), <span class="st">"\u2014"</span>, <span class="fu">format</span>(<span class="fu">as.integer</span>(x), <span class="at">big.mark =</span> <span class="st">","</span>, <span class="at">trim =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>  green_km2_str <span class="ot">&lt;-</span> <span class="fu">fmt_km2</span>(city_shp<span class="sc">$</span>green_area_m2)</span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>  green_per_1000_km2 <span class="ot">&lt;-</span> city_shp[[green_var]] <span class="sc">/</span> <span class="fl">1e6</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>  green_per_1000_str <span class="ot">&lt;-</span> <span class="fu">if_else</span>(</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    green_na,</span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.finite</span>(city_shp<span class="sc">$</span>population) <span class="sc">|</span> city_shp<span class="sc">$</span>population <span class="sc">&lt;=</span> <span class="dv">0</span>,</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>            <span class="st">"No data (missing or zero population)"</span>, <span class="st">"No data"</span>),</span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="fu">format</span>(<span class="fu">round</span>(green_per_1000_km2, <span class="dv">1</span>), <span class="at">big.mark =</span> <span class="st">","</span>, <span class="at">nsmall =</span> <span class="dv">1</span>, <span class="at">trim =</span> <span class="cn">TRUE</span>), <span class="st">" km\u00b2"</span>)</span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>  fmt_income <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">if_else</span>(<span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="sc">!</span><span class="fu">is.finite</span>(x), <span class="st">"\u2014"</span>, <span class="fu">paste0</span>(<span class="st">"$"</span>, <span class="fu">format</span>(<span class="fu">round</span>(x, <span class="dv">0</span>), <span class="at">big.mark =</span> <span class="st">","</span>, <span class="at">trim =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>  has_income_raw <span class="ot">&lt;-</span> <span class="st">"income_raw"</span> <span class="sc">%in%</span> <span class="fu">names</span>(city_shp)</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>  bivar_desc <span class="ot">&lt;-</span> BIVAR_DESCRIPTIONS[city_shp<span class="sc">$</span>bivar]</span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>  bivar_desc[<span class="fu">is.na</span>(bivar_desc)] <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>  city_shp <span class="ot">&lt;-</span> city_shp <span class="sc">%&gt;%</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>      <span class="at">popup_text =</span> <span class="fu">paste0</span>(</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:13px;'&gt;Income&lt;/b&gt;&lt;br&gt;"</span>,</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b&gt;Median household income:&lt;/b&gt; "</span>, <span class="cf">if</span> (has_income_raw) <span class="fu">fmt_income</span>(income_raw) <span class="cf">else</span> <span class="fu">fmt_income</span>(plot_income), <span class="st">"&lt;br&gt;"</span>,</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b&gt;Income Category:&lt;/b&gt; "</span>, <span class="fu">if_else</span>(<span class="fu">is.na</span>(class_income), <span class="st">"\u2014"</span>, class_income),</span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;"</span>,</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:13px;'&gt;Greenspace&lt;/b&gt;&lt;br&gt;"</span>,</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b&gt;Green area (in buffer):&lt;/b&gt; "</span>, green_km2_str, <span class="st">" km\u00b2&lt;br&gt;"</span>,</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b&gt;Population:&lt;/b&gt; "</span>, <span class="fu">fmt_pop</span>(population), <span class="st">"&lt;br&gt;"</span>,</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b&gt;Green area per 1,000 people:&lt;/b&gt; "</span>, green_per_1000_str, <span class="st">"&lt;br&gt;"</span>,</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b&gt;Green area Category:&lt;/b&gt; "</span>, <span class="fu">if_else</span>(<span class="fu">is.na</span>(class_green), <span class="st">"\u2014"</span>, class_green),</span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;"</span>,</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b&gt;Description:&lt;/b&gt; "</span>, bivar_desc</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inner-boundary stroke so outline is drawn inward and always visible (no overlap at shared edges)</span></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>  utm_zone <span class="ot">&lt;-</span> <span class="fu">floor</span>((expanded_bbox[<span class="st">"x"</span>, <span class="st">"min"</span>] <span class="sc">+</span> expanded_bbox[<span class="st">"x"</span>, <span class="st">"max"</span>]) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">180</span>) <span class="sc">%/%</span> <span class="dv">6</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>  crs_planar <span class="ot">&lt;-</span> <span class="cf">if</span> (expanded_bbox[<span class="st">"y"</span>, <span class="st">"min"</span>] <span class="sc">+</span> expanded_bbox[<span class="st">"y"</span>, <span class="st">"max"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +south +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>  inner_offset_m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>  city_utm_geom <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(<span class="fu">st_geometry</span>(city_shp), crs_planar)</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>  inner_buf <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(city_utm_geom, <span class="sc">-</span>inner_offset_m)</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>  inner_boundary <span class="ot">&lt;-</span> <span class="fu">st_boundary</span>(inner_buf)</span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>  empty_idx <span class="ot">&lt;-</span> <span class="fu">st_is_empty</span>(inner_boundary)</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(empty_idx)) {</span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>    orig_boundary <span class="ot">&lt;-</span> <span class="fu">st_boundary</span>(city_utm_geom)</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>    inner_boundary[empty_idx] <span class="ot">&lt;-</span> orig_boundary[empty_idx]</span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>  inner_boundary_wgs84 <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(inner_boundary, <span class="dv">4326</span>)</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>  city_shp_inner <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">bivar_edge_color =</span> city_shp<span class="sc">$</span>bivar_edge_color,</span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">bivar_edge_weight =</span> city_shp<span class="sc">$</span>bivar_edge_weight,</span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">geometry =</span> inner_boundary_wgs84,</span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>  extreme_idx <span class="ot">&lt;-</span> city_shp<span class="sc">$</span>bivar <span class="sc">%in%</span> BIVAR_EXTREMES</span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>  city_shp_inner_extreme <span class="ot">&lt;-</span> city_shp_inner[extreme_idx, ]</span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>  map_leaflet <span class="ot">&lt;-</span> <span class="fu">leaflet</span>(<span class="at">options =</span> <span class="fu">leafletOptions</span>(<span class="at">zoomControl =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fitBounds</span>(</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>      <span class="at">lng1 =</span> expanded_bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], <span class="at">lat1 =</span> expanded_bbox[<span class="st">"y"</span>, <span class="st">"min"</span>],</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>      <span class="at">lng2 =</span> expanded_bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], <span class="at">lat2 =</span> expanded_bbox[<span class="st">"y"</span>, <span class="st">"max"</span>]</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>Esri.WorldGrayCanvas, <span class="at">group =</span> <span class="st">"Light"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addTiles</span>(<span class="at">group =</span> <span class="st">"Street"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>Esri.WorldImagery, <span class="at">group =</span> <span class="st">"Satellite"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addPolygons</span>(</span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> bbox_polygon,</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">weight =</span> <span class="dv">2</span>, <span class="at">fill =</span> <span class="cn">FALSE</span>, <span class="at">label =</span> <span class="st">"Study area"</span>,</span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">"Study area"</span></span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addPolygons</span>(</span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> city_shp,</span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">fillColor =</span> <span class="sc">~</span>bivar_colour,</span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="sc">~</span>polygon_stroke_color,</span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">weight =</span> <span class="sc">~</span>polygon_stroke_weight,</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>      <span class="at">fillOpacity =</span> <span class="sc">~</span>bivar_opacity,</span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>      <span class="at">popup =</span> <span class="sc">~</span>popup_text,</span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">"Income × Green"</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(city_shp_inner_extreme) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>    map_leaflet <span class="ot">&lt;-</span> map_leaflet <span class="sc">%&gt;%</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addPolylines</span>(</span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> city_shp_inner_extreme,</span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="sc">~</span>bivar_edge_color,</span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>        <span class="at">weight =</span> <span class="sc">~</span>bivar_edge_weight,</span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>        <span class="at">opacity =</span> <span class="dv">1</span>,</span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>        <span class="at">group =</span> <span class="st">"Income × Green"</span></span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merged greenspace (one lightweight unioned layer for display)</span></span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Fetching merged greenspace layer (OSM) for display..."</span>)</span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>  merged_green <span class="ot">&lt;-</span> <span class="fu">fetch_greenspace_merged</span>(expanded_bbox, <span class="at">city =</span> city)</span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(merged_green) <span class="sc">||</span> <span class="fu">nrow</span>(merged_green) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  No merged greenspace layer returned (OSM query may have failed or been rate limited). Map will show DAs only."</span>)</span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(merged_green) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(merged_green) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>    map_leaflet <span class="ot">&lt;-</span> map_leaflet <span class="sc">%&gt;%</span></span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addPolygons</span>(</span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> merged_green,</span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>        <span class="at">fillColor =</span> <span class="st">"#228B22"</span>, <span class="at">fillOpacity =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="st">"#006400"</span>, <span class="at">weight =</span> <span class="dv">1</span>,</span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>        <span class="at">group =</span> <span class="st">"Greenspace (merged)"</span></span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Per-type greenspace layers (optional; disabled by default because thousands of polygons</span></span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make the HTML huge and can prevent the layer control from rendering)</span></span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>  green_group_names <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (show_green_layers) {</span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Fetching greenspace layers by OSM type (show_green_layers = TRUE)..."</span>)</span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>    green_layers <span class="ot">&lt;-</span> <span class="fu">fetch_greenspace_layers</span>(expanded_bbox)</span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(green_layers)) {</span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>      grp <span class="ot">&lt;-</span> green_layers[[i]]<span class="sc">$</span>group</span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>      sf_layer <span class="ot">&lt;-</span> green_layers[[i]]<span class="sc">$</span>sf</span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>      map_leaflet <span class="ot">&lt;-</span> map_leaflet <span class="sc">%&gt;%</span></span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addPolygons</span>(</span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> sf_layer,</span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>          <span class="at">fillColor =</span> <span class="st">"#228B22"</span>, <span class="at">fillOpacity =</span> <span class="fl">0.35</span>, <span class="at">color =</span> <span class="st">"#006400"</span>, <span class="at">weight =</span> <span class="dv">1</span>,</span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>          <span class="at">group =</span> grp</span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>      green_group_names <span class="ot">&lt;-</span> <span class="fu">c</span>(green_group_names, grp)</span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>  overlay_grps <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Income × Green"</span>, <span class="st">"Study area"</span>, <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(merged_green) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(merged_green) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="st">"Greenspace (merged)"</span>, green_group_names)</span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a>  opacity_slider_html <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;div class="leaflet-opacity-control" style="background:white;padding:8px 10px;border-radius:4px;box-shadow:0 1px 5px rgba(0,0,0,0.3);min-width:140px;"&gt;'</span>,</span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;label style="display:block;font-size:11px;font-weight:bold;margin-bottom:4px;"&gt;Overlay opacity&lt;/label&gt;'</span>,</span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;input type="range" min="0" max="100" value="60" data-overlay-opacity-slider style="width:100%;cursor:pointer;"&gt;'</span>,</span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;/div&gt;'</span></span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a>  map_leaflet <span class="ot">&lt;-</span> map_leaflet <span class="sc">%&gt;%</span></span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addLayersControl</span>(</span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a>      <span class="at">position =</span> <span class="st">"topright"</span>,</span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>      <span class="at">baseGroups =</span> <span class="fu">c</span>(<span class="st">"Light"</span>, <span class="st">"Street"</span>, <span class="st">"Satellite"</span>),</span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlayGroups =</span> overlay_grps,</span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a>      <span class="at">options =</span> <span class="fu">layersControlOptions</span>(<span class="at">collapsed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addControl</span>(</span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a>      <span class="at">html =</span> <span class="fu">HTML</span>(<span class="fu">bivariate_legend_html</span>()),</span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a>      <span class="at">position =</span> <span class="st">"bottomleft"</span></span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addControl</span>(</span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>      <span class="at">html =</span> <span class="fu">HTML</span>(opacity_slider_html),</span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a>      <span class="at">position =</span> <span class="st">"bottomright"</span></span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a>    htmlwidgets<span class="sc">::</span><span class="fu">onRender</span>(</span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>      <span class="st">"function(el, x) {</span></span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a><span class="st">        var w = HTMLWidgets.find('#' + el.id);</span></span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a><span class="st">        if (!w || typeof w.getMap !== 'function') return;</span></span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a><span class="st">        var map = w.getMap();</span></span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a><span class="st">        if (!map) return;</span></span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a><span class="st">        var lm = map.layerManager;</span></span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a><span class="st">        if (!lm || typeof lm.getLayerGroup !== 'function') return;</span></span>
<span id="cb1-370"><a href="#cb1-370" aria-hidden="true" tabindex="-1"></a><span class="st">        var overlayGroups = ['Study area', 'Income × Green', 'Greenspace (merged)'];</span></span>
<span id="cb1-371"><a href="#cb1-371" aria-hidden="true" tabindex="-1"></a><span class="st">        function applyOpacityToGroup(groupName, v) {</span></span>
<span id="cb1-372"><a href="#cb1-372" aria-hidden="true" tabindex="-1"></a><span class="st">          var group = lm.getLayerGroup(groupName, false);</span></span>
<span id="cb1-373"><a href="#cb1-373" aria-hidden="true" tabindex="-1"></a><span class="st">          if (group &amp;&amp; group.eachLayer) {</span></span>
<span id="cb1-374"><a href="#cb1-374" aria-hidden="true" tabindex="-1"></a><span class="st">            group.eachLayer(function(l) {</span></span>
<span id="cb1-375"><a href="#cb1-375" aria-hidden="true" tabindex="-1"></a><span class="st">              if (l.setStyle) l.setStyle({ fillOpacity: v, opacity: v });</span></span>
<span id="cb1-376"><a href="#cb1-376" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb1-377"><a href="#cb1-377" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb1-378"><a href="#cb1-378" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb1-379"><a href="#cb1-379" aria-hidden="true" tabindex="-1"></a><span class="st">        function setOverlayOpacity(pct) {</span></span>
<span id="cb1-380"><a href="#cb1-380" aria-hidden="true" tabindex="-1"></a><span class="st">          var v = Math.max(0, Math.min(1, pct / 100));</span></span>
<span id="cb1-381"><a href="#cb1-381" aria-hidden="true" tabindex="-1"></a><span class="st">          overlayGroups.forEach(function(name) { applyOpacityToGroup(name, v); });</span></span>
<span id="cb1-382"><a href="#cb1-382" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb1-383"><a href="#cb1-383" aria-hidden="true" tabindex="-1"></a><span class="st">        function init() {</span></span>
<span id="cb1-384"><a href="#cb1-384" aria-hidden="true" tabindex="-1"></a><span class="st">          function hideGreenspace() {</span></span>
<span id="cb1-385"><a href="#cb1-385" aria-hidden="true" tabindex="-1"></a><span class="st">            if (typeof map.hideGroup === 'function') {</span></span>
<span id="cb1-386"><a href="#cb1-386" aria-hidden="true" tabindex="-1"></a><span class="st">              map.hideGroup('Greenspace (merged)');</span></span>
<span id="cb1-387"><a href="#cb1-387" aria-hidden="true" tabindex="-1"></a><span class="st">            } else {</span></span>
<span id="cb1-388"><a href="#cb1-388" aria-hidden="true" tabindex="-1"></a><span class="st">              var g = lm.getLayerGroup('Greenspace (merged)', false);</span></span>
<span id="cb1-389"><a href="#cb1-389" aria-hidden="true" tabindex="-1"></a><span class="st">              if (g &amp;&amp; map.hasLayer &amp;&amp; map.hasLayer(g)) map.removeLayer(g);</span></span>
<span id="cb1-390"><a href="#cb1-390" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb1-391"><a href="#cb1-391" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb1-392"><a href="#cb1-392" aria-hidden="true" tabindex="-1"></a><span class="st">          hideGreenspace();</span></span>
<span id="cb1-393"><a href="#cb1-393" aria-hidden="true" tabindex="-1"></a><span class="st">          setTimeout(hideGreenspace, 100);</span></span>
<span id="cb1-394"><a href="#cb1-394" aria-hidden="true" tabindex="-1"></a><span class="st">          var slider = el.querySelector('input[data-overlay-opacity-slider]');</span></span>
<span id="cb1-395"><a href="#cb1-395" aria-hidden="true" tabindex="-1"></a><span class="st">          if (slider) {</span></span>
<span id="cb1-396"><a href="#cb1-396" aria-hidden="true" tabindex="-1"></a><span class="st">            setOverlayOpacity(parseInt(slider.value, 10));</span></span>
<span id="cb1-397"><a href="#cb1-397" aria-hidden="true" tabindex="-1"></a><span class="st">            slider.addEventListener('input', function() {</span></span>
<span id="cb1-398"><a href="#cb1-398" aria-hidden="true" tabindex="-1"></a><span class="st">              setOverlayOpacity(parseInt(slider.value, 10));</span></span>
<span id="cb1-399"><a href="#cb1-399" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb1-400"><a href="#cb1-400" aria-hidden="true" tabindex="-1"></a><span class="st">            var control = slider.closest('.leaflet-opacity-control') || slider.parentElement;</span></span>
<span id="cb1-401"><a href="#cb1-401" aria-hidden="true" tabindex="-1"></a><span class="st">            if (control) {</span></span>
<span id="cb1-402"><a href="#cb1-402" aria-hidden="true" tabindex="-1"></a><span class="st">              ['mousedown', 'touchstart', 'click', 'dblclick'].forEach(function(ev) {</span></span>
<span id="cb1-403"><a href="#cb1-403" aria-hidden="true" tabindex="-1"></a><span class="st">                control.addEventListener(ev, function(e) { e.stopPropagation(); }, true);</span></span>
<span id="cb1-404"><a href="#cb1-404" aria-hidden="true" tabindex="-1"></a><span class="st">              });</span></span>
<span id="cb1-405"><a href="#cb1-405" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb1-406"><a href="#cb1-406" aria-hidden="true" tabindex="-1"></a><span class="st">          }</span></span>
<span id="cb1-407"><a href="#cb1-407" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb1-408"><a href="#cb1-408" aria-hidden="true" tabindex="-1"></a><span class="st">        if (map.whenReady) {</span></span>
<span id="cb1-409"><a href="#cb1-409" aria-hidden="true" tabindex="-1"></a><span class="st">          map.whenReady(init);</span></span>
<span id="cb1-410"><a href="#cb1-410" aria-hidden="true" tabindex="-1"></a><span class="st">        } else {</span></span>
<span id="cb1-411"><a href="#cb1-411" aria-hidden="true" tabindex="-1"></a><span class="st">          setTimeout(init, 150);</span></span>
<span id="cb1-412"><a href="#cb1-412" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb1-413"><a href="#cb1-413" aria-hidden="true" tabindex="-1"></a><span class="st">      }"</span></span>
<span id="cb1-414"><a href="#cb1-414" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-415"><a href="#cb1-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-416"><a href="#cb1-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Step 4 of 5: Saving map..."</span>)</span>
<span id="cb1-417"><a href="#cb1-417" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="st">"output/maps"</span></span>
<span id="cb1-418"><a href="#cb1-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-419"><a href="#cb1-419" aria-hidden="true" tabindex="-1"></a>  out_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">normalizePath</span>(out_dir, <span class="at">mustWork =</span> <span class="cn">FALSE</span>), <span class="fu">paste0</span>(modified_text, <span class="st">"_bivariate.html"</span>))</span>
<span id="cb1-420"><a href="#cb1-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveWidget</span>(map_leaflet, <span class="at">file =</span> out_file, <span class="at">selfcontained =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-421"><a href="#cb1-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Step 5 of 5: Done. Map saved to "</span>, out_file)</span>
<span id="cb1-422"><a href="#cb1-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"  Open the HTML in a browser; keep the _files/ folder next to it."</span>)</span>
<span id="cb1-423"><a href="#cb1-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(map_leaflet)</span>
<span id="cb1-424"><a href="#cb1-424" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="script-mapping-functions" class="level2">
<h2 class="anchored" data-anchor-id="script-mapping-functions">mapping_functions.R</h2>
<p><strong>What it does:</strong> Helper functions for the Leaflet map: <code>create_custom_icon</code>, <code>add_markers_conditionally</code>, <code>add_polylines_conditionally</code>, and <code>add_polygons_conditionally</code> to add OSM features (parks, playgrounds, nature, etc.) as toggleable layers with popups. Used when <code>show_green_layers = TRUE</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmltools)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>create_custom_icon <span class="ot">&lt;-</span> <span class="cf">function</span>(icon_url, <span class="at">icon_width =</span> <span class="dv">40</span>, <span class="at">icon_height =</span> <span class="dv">40</span>) {</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">makeIcon</span>(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">iconUrl =</span> icon_url,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">iconWidth =</span> icon_width,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">iconHeight =</span> icon_height,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iconAnchorX =</span> icon_width <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">iconAnchorY =</span> <span class="dv">0</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>add_markers_conditionally <span class="ot">&lt;-</span> <span class="cf">function</span>(map, data, group_name, icon_url, <span class="at">icon_width =</span> <span class="dv">40</span>, <span class="at">icon_height =</span> <span class="dv">40</span>) {</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">popup_info =</span> <span class="fu">glue</span>(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>          <span class="st">"&lt;b&gt;Type:&lt;/b&gt; {if ('amenity' %in% colnames(data)) amenity else if ('leisure' %in% colnames(data)) leisure else 'Green space'}&lt;br&gt;"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>          <span class="st">"&lt;b&gt;Name:&lt;/b&gt; {if ('name' %in% colnames(data)) ifelse(!is.na(name), name, 'No name available') else 'No name available'}"</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    custom_icon <span class="ot">&lt;-</span> <span class="fu">create_custom_icon</span>(icon_url, <span class="at">icon_width =</span> icon_width, <span class="at">icon_height =</span> icon_height)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">&lt;-</span> map <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addMarkers</span>(<span class="at">data =</span> data, <span class="at">icon =</span> custom_icon, <span class="at">popup =</span> <span class="sc">~</span>popup_info, <span class="at">group =</span> group_name)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(map)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>add_polylines_conditionally <span class="ot">&lt;-</span> <span class="cf">function</span>(map, data, group_name, color) {</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">popup_info =</span> <span class="fu">ifelse</span>(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>          <span class="st">"name"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(data),</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(<span class="st">"&lt;b&gt;Type:&lt;/b&gt; {highway}&lt;br&gt;&lt;b&gt;Name:&lt;/b&gt; {name}"</span>),</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(<span class="st">"&lt;b&gt;Type:&lt;/b&gt; {highway}&lt;br&gt;&lt;b&gt;Name:&lt;/b&gt; No name available"</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">&lt;-</span> map <span class="sc">%&gt;%</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addPolylines</span>(<span class="at">data =</span> data, <span class="at">color =</span> color, <span class="at">weight =</span> <span class="dv">3</span>, <span class="at">opacity =</span> <span class="fl">0.8</span>, <span class="at">popup =</span> <span class="sc">~</span>popup_info, <span class="at">group =</span> group_name)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(map)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>add_polygons_conditionally <span class="ot">&lt;-</span> <span class="cf">function</span>(map, data, group_name, fill_color) {</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">popup_info =</span> <span class="fu">ifelse</span>(</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>          <span class="st">"name"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(data),</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(<span class="st">"&lt;b&gt;Type:&lt;/b&gt; {amenity}&lt;br&gt;&lt;b&gt;Name:&lt;/b&gt; {name}"</span>),</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(<span class="st">"&lt;b&gt;Type:&lt;/b&gt; {amenity}&lt;br&gt;&lt;b&gt;Name:&lt;/b&gt; No name available"</span>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    map <span class="ot">&lt;-</span> map <span class="sc">%&gt;%</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addPolygons</span>(<span class="at">data =</span> data, <span class="at">fillColor =</span> fill_color, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">weight =</span> <span class="dv">1</span>, <span class="at">fillOpacity =</span> <span class="fl">0.6</span>, <span class="at">popup =</span> <span class="sc">~</span>popup_info, <span class="at">group =</span> group_name)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(map)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="script-map-config" class="level2">
<h2 class="anchored" data-anchor-id="script-map-config">map_config.R</h2>
<p><strong>What it does:</strong> Central configuration list for SES (income) categories and green-space settings. Defines <code>ses</code> (labels, colours, emoji, SD multipliers for 5 income bands) and <code>green</code> (thresholds for Limited/Good/Great, icon URLs for parks/playgrounds/nature). Used by build_ses_index.R and process_green.R; create_bivariate_map.R uses its own bivariate palette.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration for SES/income index and green space.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Used by:</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   build_ses_index.R  - ses$labels, ses$sd_multipliers (income status categories in output)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   process_green.R    - green$thresholds (Limited/Good/Great counts), green$icon_* (markers)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   create_bivariate_map.R - uses its own bivariate palette; does not use this config</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit this file to change index categories, colours, icons, or green-space thresholds.</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>map_config <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- SES (socioeconomic status) ---</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Order: [1] = Lowest ... [5] = Highest. Same order for colours, labels, and emoji (for popups).</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Colours: Lowest=red, Low=yellow, Average=green, High=blue, Highest=purple (matches pop-up emojis).</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">ses =</span> <span class="fu">list</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Lowest"</span>, <span class="st">"Low"</span>, <span class="st">"Average"</span>, <span class="st">"High"</span>, <span class="st">"Highest"</span>),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">colours =</span> <span class="fu">c</span>(<span class="st">"#D72638"</span>, <span class="st">"#FFCC00"</span>, <span class="st">"#3DBB61"</span>, <span class="st">"#0078D7"</span>, <span class="st">"#6F008C"</span>),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Emoji shown beside category in popup (National Comparison): 🔴 Lowest, 🟡 Low, 🟢 Average, 🔵 High, 🟣 Highest</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">emoji =</span> <span class="fu">c</span>(<span class="st">"🔴"</span>, <span class="st">"🟡"</span>, <span class="st">"🟢"</span>, <span class="st">"🔵"</span>, <span class="st">"🟣"</span>),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SD multipliers for break boundaries: mean + sd_multipliers * sd (4 values =&gt; 5 categories)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_multipliers =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Green space ---</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">green =</span> <span class="fu">list</span>(</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count thresholds for green status (parks + playgrounds + nature in study area)</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Above great =&gt; "Great", above good =&gt; "Good", above limited =&gt; "Limited", else "None"</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">great =</span> <span class="dv">20</span>L, <span class="at">good =</span> <span class="dv">5</span>L, <span class="at">limited =</span> <span class="dv">1</span>L),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marker icon URLs</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">icon_url =</span> <span class="fu">list</span>(</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">parks           =</span> <span class="st">"https://cdn-icons-png.flaticon.com/512/284/284648.png"</span>,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">playgrounds     =</span> <span class="st">"https://cdn-icons-png.flaticon.com/512/619/619032.png"</span>,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">nature_reserves =</span> <span class="st">"https://cdn-icons-png.flaticon.com/512/3073/3073484.png"</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">icon_width  =</span> <span class="dv">40</span>L,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">icon_height =</span> <span class="dv">40</span>L</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="script-process-green-da" class="level2">
<h2 class="anchored" data-anchor-id="script-process-green-da">process_green_da.R</h2>
<p><strong>What it does:</strong> Computes green area per dissemination area (and per 1,000 people). For each DA, sums OSM greenspace (parks, gardens, meadows, etc.) inside the DA plus within a walkable buffer (e.g.&nbsp;500 m). Fetches OSM for the study bbox, merges polygon types, intersects with buffered DAs, and returns DAs with <code>green_area_m2</code> and <code>green_area_per_1000</code>. Handles Overpass rate limiting and uses cache_utils for optional caching.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Green area per DA (and per 1000 people). Uses multiple OSM greenspace types and optional</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># walkable buffer around each DA.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Input: da_sf (clipped DAs with 'population'), bbox (matrix x/y min/max, WGS84).</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: buffer_m = walkable distance in metres (e.g. 500 m).</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For each DA, greenspace area is summed over: (1) the DA itself, plus (2) the area</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># within buffer_m of the DA boundary. So the zone is "inside the DA + within X m of</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># the DA" (st_buffer(DA, buffer_m) gives exactly that). This reflects access to</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># greenspace both inside and just outside the DA (reduces MAUP; helps edge DAs).</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># OSM greenspace is fetched for bbox only; use a larger bbox (e.g. custom_distance_km)</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># if you want full counts where the buffer extends beyond the study area.</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns: da_sf with green_area_m2 and green_area_per_1000 added.</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">dir.exists</span>(<span class="st">"R"</span>)) <span class="fu">source</span>(<span class="st">"R/cache_utils.R"</span>) <span class="cf">else</span> <span class="fu">source</span>(<span class="st">"cache_utils.R"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Check Overpass/OSM error message for rate limiting or known API errors; warn and return TRUE if so</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>warn_if_overpass_error <span class="ot">&lt;-</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="fu">conditionMessage</span>(e)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.character</span>(msg) <span class="sc">||</span> <span class="fu">length</span>(msg) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  rate_limit <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="st">"429|503|rate limit|rate-limited|too many requests|service unavailable|timeout|timed out|overpass"</span>, msg, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (rate_limit) {</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">"OSM/Overpass API may be rate limiting or overloaded. "</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Error: "</span>, msg, <span class="st">" "</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Wait a few minutes and re-run, or use set_overpass_url() in osmdata to try another server."</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">call. =</span> <span class="cn">FALSE</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">TRUE</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  <span class="cn">FALSE</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co"># OSM key/value pairs for public greenspace (parks, gardens, forests, meadows, etc.)</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co"># OSM key/value pairs merged into the greenspace layer (polygons + multipolygons)</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>OSM_GREEN_FEATURES <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"leisure"</span>, <span class="at">value =</span> <span class="st">"dog_park"</span>),</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"leisure"</span>, <span class="at">value =</span> <span class="st">"garden"</span>),</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"leisure"</span>, <span class="at">value =</span> <span class="st">"park"</span>),</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"leisure"</span>, <span class="at">value =</span> <span class="st">"pitch"</span>),</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"landcover"</span>, <span class="at">value =</span> <span class="st">"grass"</span>),</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"landuse"</span>, <span class="at">value =</span> <span class="st">"meadow"</span>),</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"landuse"</span>, <span class="at">value =</span> <span class="st">"recreation_ground"</span>),</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"landuse"</span>, <span class="at">value =</span> <span class="st">"village_green"</span>),</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"landuse"</span>, <span class="at">value =</span> <span class="st">"grass"</span>),</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"landuse"</span>, <span class="at">value =</span> <span class="st">"greenery"</span>),</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"landuse"</span>, <span class="at">value =</span> <span class="st">"allotments"</span>),</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"natural"</span>, <span class="at">value =</span> <span class="st">"heath"</span>),</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"natural"</span>, <span class="at">value =</span> <span class="st">"scrub"</span>),</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"natural"</span>, <span class="at">value =</span> <span class="st">"wetland"</span>),</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"natural"</span>, <span class="at">value =</span> <span class="st">"grassland"</span>),</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"natural"</span>, <span class="at">value =</span> <span class="st">"shrubbery"</span>),</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"natural"</span>, <span class="at">value =</span> <span class="st">"tundra"</span>),</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">key =</span> <span class="st">"natural"</span>, <span class="at">value =</span> <span class="st">"wood"</span>)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>process_green_da <span class="ot">&lt;-</span> <span class="cf">function</span>(da_sf, bbox, <span class="at">buffer_m =</span> <span class="dv">2000</span>, <span class="at">city =</span> <span class="cn">NULL</span>) {</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(da_sf) <span class="sc">||</span> <span class="fu">nrow</span>(da_sf) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="sc">!</span><span class="st">"population"</span> <span class="sc">%in%</span> <span class="fu">names</span>(da_sf)) {</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    da_sf<span class="sc">$</span>green_area_m2 <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    da_sf<span class="sc">$</span>green_area_per_1000 <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(da_sf)</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Coerce population to numeric (GPKG/read_sf can sometimes return character)</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>  da_sf<span class="sc">$</span>population <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(da_sf<span class="sc">$</span>population))</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  bbox_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], bbox[<span class="st">"y"</span>, <span class="st">"min"</span>], bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], bbox[<span class="st">"y"</span>, <span class="st">"max"</span>])</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Planar CRS for area (m²) and buffer</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>  utm_zone <span class="ot">&lt;-</span> <span class="fu">floor</span>((bbox[<span class="st">"x"</span>, <span class="st">"min"</span>] <span class="sc">+</span> bbox[<span class="st">"x"</span>, <span class="st">"max"</span>]) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">180</span>) <span class="sc">%/%</span> <span class="dv">6</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (bbox[<span class="st">"y"</span>, <span class="st">"min"</span>] <span class="sc">+</span> bbox[<span class="st">"y"</span>, <span class="st">"max"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    crs_planar <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    crs_planar <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +south +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>  da_sf<span class="sc">$</span>._da_row <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(da_sf))</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>  da_utm <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(da_sf <span class="sc">%&gt;%</span> <span class="fu">select</span>(._da_row), crs_planar)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Greenspace: try cache (by bbox UID), else fetch OSM and merge ---</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  greens_union <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>  greens_cached <span class="ot">&lt;-</span> <span class="fu">get_cached_greenspace</span>(bbox)</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(greens_cached) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(greens_cached) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    greens_utm <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(greens_cached, crs_planar)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(greens_utm))) greens_utm <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(greens_utm)</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    greens_union <span class="ot">&lt;-</span> <span class="fu">st_union</span>(<span class="fu">st_geometry</span>(greens_utm))</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(greens_union) <span class="sc">&gt;</span> <span class="dv">1</span>) greens_union <span class="ot">&lt;-</span> <span class="fu">st_union</span>(greens_union)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Using cached greenspace for this bbox. Green area uses buffer "</span>, buffer_m, <span class="st">" m."</span>)</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(greens_union)) {</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fetch all greenspace polygon types and combine (polygons + multipolygons so e.g. natural=wood is included)</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    collect_polygons <span class="ot">&lt;-</span> <span class="cf">function</span>(key, value) {</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        od <span class="ot">&lt;-</span> <span class="fu">opq</span>(bbox_vec) <span class="sc">%&gt;%</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>          <span class="fu">add_osm_feature</span>(<span class="at">key =</span> key, <span class="at">value =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>          <span class="fu">osmdata_sf</span>()</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        polys <span class="ot">&lt;-</span> od<span class="sc">$</span>osm_polygons</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        multi <span class="ot">&lt;-</span> od<span class="sc">$</span>osm_multipolygons</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(multi) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(multi) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>          multi <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(multi <span class="sc">%&gt;%</span> <span class="fu">select</span>(geometry), <span class="st">"POLYGON"</span>, <span class="at">warn =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">is.null</span>(polys) <span class="sc">||</span> <span class="fu">nrow</span>(polys) <span class="sc">==</span> <span class="dv">0</span>) polys <span class="ot">&lt;-</span> multi</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> polys <span class="ot">&lt;-</span> <span class="fu">rbind</span>(polys <span class="sc">%&gt;%</span> <span class="fu">select</span>(geometry), multi)</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.null</span>(polys) <span class="sc">||</span> <span class="fu">nrow</span>(polys) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">NULL</span> <span class="cf">else</span> polys</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warn_if_overpass_error</span>(e)</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    poly_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(OSM_GREEN_FEATURES, <span class="cf">function</span>(f) <span class="fu">collect_polygons</span>(f<span class="sc">$</span>key, f<span class="sc">$</span>value))</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>    poly_list <span class="ot">&lt;-</span> poly_list[<span class="sc">!</span><span class="fu">sapply</span>(poly_list, is.null)]</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>    poly_list <span class="ot">&lt;-</span> poly_list[<span class="fu">sapply</span>(poly_list, nrow) <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(poly_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>        <span class="st">"No OSM greenspace polygons returned for this bbox. "</span>,</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>        <span class="st">"If you ran this repeatedly, Overpass may be rate limiting; wait a few minutes and try again."</span>,</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>        <span class="at">call. =</span> <span class="cn">FALSE</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>      da_sf<span class="sc">$</span>green_area_m2 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>      da_sf<span class="sc">$</span>green_area_per_1000 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>      da_sf<span class="sc">$</span>._da_row <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(da_sf)</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>    greens_sf <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(poly_list, <span class="cf">function</span>(x) x <span class="sc">%&gt;%</span> <span class="fu">select</span>(geometry)))</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(greens_sf))) greens_sf <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(greens_sf)</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>    greens_utm <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(greens_sf, crs_planar)</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(greens_utm))) greens_utm <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(greens_utm)</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>    greens_geom <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(greens_utm)</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>    n_poly <span class="ot">&lt;-</span> <span class="fu">nrow</span>(greens_utm)</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>    greens_union <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_union</span>(greens_geom),</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"st_union failed ("</span>, <span class="fu">conditionMessage</span>(e), <span class="st">"); trying buffer(0) to fix topology..."</span>)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>        fixed <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">st_buffer</span>(greens_utm, <span class="dv">0</span>), <span class="at">error =</span> <span class="cf">function</span>(e2) greens_utm)</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(fixed))) fixed <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(fixed)</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tryCatch</span>(</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>          <span class="fu">st_union</span>(<span class="fu">st_geometry</span>(fixed)),</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>          <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>            <span class="fu">message</span>(<span class="st">"buffer(0) union failed; trying chunked union..."</span>)</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>            chunk <span class="ot">&lt;-</span> <span class="dv">200</span>L</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>            idx <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(fixed))</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>            chunks <span class="ot">&lt;-</span> <span class="fu">split</span>(idx, <span class="fu">ceiling</span>(idx <span class="sc">/</span> chunk))</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>            parts <span class="ot">&lt;-</span> <span class="fu">lapply</span>(chunks, <span class="cf">function</span>(i) <span class="fu">st_union</span>(<span class="fu">st_geometry</span>(fixed[i, ])))</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Reduce</span>(st_union, parts)</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(greens_union) <span class="sc">&gt;</span> <span class="dv">1</span>) greens_union <span class="ot">&lt;-</span> <span class="fu">st_union</span>(greens_union)</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Merged "</span>, n_poly, <span class="st">" greenspace polygons into one layer (overlaps counted once). Green area uses buffer "</span>, buffer_m, <span class="st">" m."</span>)</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cache merged greenspace (WGS84)</span></span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>    greens_sf_planar <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> <span class="fu">st_sfc</span>(greens_union, <span class="at">crs =</span> crs_planar))</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_cached_greenspace</span>(bbox, <span class="fu">st_transform</span>(greens_sf_planar, <span class="dv">4326</span>), <span class="at">city =</span> city)</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Buffered DAs: try cache (by bbox UID + buffer_m), else compute ---</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>  cached_buf <span class="ot">&lt;-</span> <span class="fu">get_cached_buffers</span>(bbox, buffer_m)</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>  use_cached_buf <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cached_buf) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(cached_buf) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all</span>(da_sf<span class="sc">$</span>._da_row <span class="sc">%in%</span> cached_buf<span class="sc">$</span>da_row) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(cached_buf) <span class="sc">==</span> <span class="fu">nrow</span>(da_sf)) {</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>    geoms <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(<span class="fu">st_transform</span>(cached_buf, crs_planar))</span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>    da_utm <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(</span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>      <span class="at">._da_row =</span> da_sf<span class="sc">$</span>._da_row,</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>      <span class="at">geometry =</span> geoms[<span class="fu">match</span>(da_sf<span class="sc">$</span>._da_row, cached_buf<span class="sc">$</span>da_row)],</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>      <span class="at">crs =</span> crs_planar</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>    use_cached_buf <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Using cached buffered DAs for this bbox and buffer "</span>, buffer_m, <span class="st">" m."</span>)</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Zone for summing greenspace = DA plus buffer (so greenspace inside DA + within buffer_m counts)</span></span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>use_cached_buf <span class="sc">&amp;&amp;</span> buffer_m <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>    da_utm <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(da_utm, buffer_m)</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_cached_buffers</span>(bbox, buffer_m, da_utm, <span class="at">city =</span> city)</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>  int <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_intersection</span>(da_utm, greens_union)</span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(int) <span class="sc">||</span> <span class="fu">nrow</span>(int) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>    da_sf<span class="sc">$</span>green_area_m2 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>    da_sf<span class="sc">$</span>green_area_per_1000 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>    da_sf<span class="sc">$</span>._da_row <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(da_sf)</span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">$</span>area_m2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">st_area</span>(int))</span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>  agg <span class="ot">&lt;-</span> int <span class="sc">%&gt;%</span></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(._da_row) <span class="sc">%&gt;%</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">green_area_m2 =</span> <span class="fu">sum</span>(area_m2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>  da_sf <span class="ot">&lt;-</span> da_sf <span class="sc">%&gt;%</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(agg, <span class="at">by =</span> <span class="st">"._da_row"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">green_area_m2 =</span> <span class="fu">replace_na</span>(green_area_m2, <span class="dv">0</span>))</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>  da_sf<span class="sc">$</span>._da_row <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Green area per 1000 people: (m²) * 1000 / population</span></span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>  pop <span class="ot">&lt;-</span> da_sf<span class="sc">$</span>population</span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>  pop[<span class="sc">!</span><span class="fu">is.finite</span>(pop) <span class="sc">|</span> pop <span class="sc">&lt;=</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>  da_sf<span class="sc">$</span>green_area_per_1000 <span class="ot">&lt;-</span> (da_sf<span class="sc">$</span>green_area_m2 <span class="sc">*</span> <span class="dv">1000</span>) <span class="sc">/</span> pop</span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>  da_sf<span class="sc">$</span>green_area_per_1000[<span class="sc">!</span><span class="fu">is.finite</span>(da_sf<span class="sc">$</span>green_area_per_1000)] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>  da_sf</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch greenspace polygons by OSM type for toggleable map layers (WGS84).</span></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes both osm_polygons and osm_multipolygons (e.g. natural=wood) so nothing is missed.</span></span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>fetch_greenspace_layers <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox) {</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>  bbox_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], bbox[<span class="st">"y"</span>, <span class="st">"min"</span>], bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], bbox[<span class="st">"y"</span>, <span class="st">"max"</span>])</span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (f <span class="cf">in</span> OSM_GREEN_FEATURES) {</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>    label <span class="ot">&lt;-</span> <span class="fu">paste0</span>(f<span class="sc">$</span>key, <span class="st">": "</span>, f<span class="sc">$</span>value)</span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>    poly <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>      od <span class="ot">&lt;-</span> <span class="fu">opq</span>(bbox_vec) <span class="sc">%&gt;%</span> <span class="fu">add_osm_feature</span>(<span class="at">key =</span> f<span class="sc">$</span>key, <span class="at">value =</span> f<span class="sc">$</span>value) <span class="sc">%&gt;%</span> <span class="fu">osmdata_sf</span>()</span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>      polys <span class="ot">&lt;-</span> od<span class="sc">$</span>osm_polygons</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>      multi <span class="ot">&lt;-</span> od<span class="sc">$</span>osm_multipolygons</span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(multi) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(multi) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>        multi <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(multi <span class="sc">%&gt;%</span> <span class="fu">select</span>(geometry), <span class="st">"POLYGON"</span>, <span class="at">warn =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.null</span>(polys) <span class="sc">||</span> <span class="fu">nrow</span>(polys) <span class="sc">==</span> <span class="dv">0</span>) polys <span class="ot">&lt;-</span> multi <span class="cf">else</span> polys <span class="ot">&lt;-</span> <span class="fu">rbind</span>(polys <span class="sc">%&gt;%</span> <span class="fu">select</span>(geometry), multi)</span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(polys) <span class="sc">||</span> <span class="fu">nrow</span>(polys) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">NULL</span> <span class="cf">else</span> (polys <span class="sc">%&gt;%</span> <span class="fu">select</span>(geometry))</span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warn_if_overpass_error</span>(e)</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(poly) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(poly) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(poly))) poly <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(poly)</span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>      out[[label]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">group =</span> label, <span class="at">sf =</span> poly)</span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch all greenspace, merge (union) into one layer so overlaps are single polygons (WGS84).</span></span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a><span class="co"># Use for display so the map shows one merged layer with no double-drawn overlap.</span></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a><span class="co"># Uses GeoPackage cache by bbox UID when available; otherwise fetches OSM and caches result.</span></span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>fetch_greenspace_merged <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, <span class="at">city =</span> <span class="cn">NULL</span>) {</span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>  cached <span class="ot">&lt;-</span> <span class="fu">get_cached_greenspace</span>(bbox)</span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cached) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(cached) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Using cached merged greenspace for this bbox."</span>)</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(cached)</span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>  layers <span class="ot">&lt;-</span> <span class="fu">fetch_greenspace_layers</span>(bbox)</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(layers) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>  all_sf <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(layers, <span class="cf">function</span>(x) x<span class="sc">$</span>sf))</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(all_sf) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(all_sf))) all_sf <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(all_sf)</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>  utm_zone <span class="ot">&lt;-</span> <span class="fu">floor</span>((bbox[<span class="st">"x"</span>, <span class="st">"min"</span>] <span class="sc">+</span> bbox[<span class="st">"x"</span>, <span class="st">"max"</span>]) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">180</span>) <span class="sc">%/%</span> <span class="dv">6</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (bbox[<span class="st">"y"</span>, <span class="st">"min"</span>] <span class="sc">+</span> bbox[<span class="st">"y"</span>, <span class="st">"max"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>    crs_planar <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>    crs_planar <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +south +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>  planar <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(all_sf, crs_planar)</span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(planar))) planar <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(planar)</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>  geom <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(planar)</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>  merged <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_union</span>(geom),</span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"fetch_greenspace_merged: st_union failed ("</span>, <span class="fu">conditionMessage</span>(e), <span class="st">"); trying buffer(0)..."</span>)</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>      fixed <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">st_buffer</span>(planar, <span class="dv">0</span>), <span class="at">error =</span> <span class="cf">function</span>(e2) planar)</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(fixed))) fixed <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(fixed)</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tryCatch</span>(</span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_union</span>(<span class="fu">st_geometry</span>(fixed)),</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>          <span class="fu">message</span>(<span class="st">"fetch_greenspace_merged: trying chunked union..."</span>)</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>          n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(fixed)</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>          chunk <span class="ot">&lt;-</span> <span class="dv">200</span>L</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>          idx <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(n)</span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>          chunks <span class="ot">&lt;-</span> <span class="fu">split</span>(idx, <span class="fu">ceiling</span>(idx <span class="sc">/</span> chunk))</span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>          parts <span class="ot">&lt;-</span> <span class="fu">lapply</span>(chunks, <span class="cf">function</span>(i) <span class="fu">st_union</span>(<span class="fu">st_geometry</span>(fixed[i, ])))</span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>          <span class="fu">Reduce</span>(st_union, parts)</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(merged) <span class="sc">&gt;</span> <span class="dv">1</span>) merged <span class="ot">&lt;-</span> <span class="fu">st_union</span>(merged)</span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>  merged_sf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> merged, <span class="at">crs =</span> crs_planar)</span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>  merged_wgs84 <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(merged_sf, <span class="fu">st_crs</span>(all_sf))</span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> <span class="fu">st_geometry</span>(merged_wgs84), <span class="at">crs =</span> <span class="fu">st_crs</span>(all_sf))</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_cached_greenspace</span>(bbox, result, <span class="at">city =</span> city)</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="script-process-green" class="level2">
<h2 class="anchored" data-anchor-id="script-process-green">process_green.R</h2>
<p><strong>What it does:</strong> Fetches OSM green-space data (parks, playgrounds, nature reserves) for a given bbox and returns a list with green_status (Limited/Good/Great by count), plus sf layers for parks, playgrounds, and nature (as centroids for markers). Used for green-status summaries or optional marker layers; create_bivariate_map uses process_green_da for per-DA green area.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># OSM green space data and study-area green access status (parks, playgrounds, nature reserves).</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Input: bbox (matrix with rownames "x","y" and colnames "min","max").</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns: list with green_status (Limited/Good/Great), parks_sf, playgrounds_sf, etc.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: create_bivariate_map uses process_green_da.R and fetch_greenspace_* only; this script is for other use (e.g. green-status summaries or marker layers).</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>process_green <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox) {</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(bbox) <span class="sc">||</span> <span class="sc">!</span><span class="fu">identical</span>(<span class="fu">rownames</span>(bbox), <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>))) {</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">green_status =</span> <span class="cn">NA_character_</span>, <span class="at">parks_sf =</span> <span class="cn">NULL</span>, <span class="at">playgrounds_sf =</span> <span class="cn">NULL</span>))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  bbox_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], bbox[<span class="st">"y"</span>, <span class="st">"min"</span>], bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], bbox[<span class="st">"y"</span>, <span class="st">"max"</span>])</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parks (polygons → centroids for markers)</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  parks <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">opq</span>(bbox_vec) <span class="sc">%&gt;%</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"leisure"</span>, <span class="at">value =</span> <span class="st">"park"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">osmdata_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>      .<span class="sc">$</span>osm_polygons</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  parks_pts <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(parks) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(parks) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">st_centroid</span>(parks) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Playgrounds</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  playgrounds <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">opq</span>(bbox_vec) <span class="sc">%&gt;%</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"leisure"</span>, <span class="at">value =</span> <span class="st">"playground"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">osmdata_sf</span>()</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  play_poly <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(playgrounds<span class="sc">$</span>osm_polygons) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(playgrounds<span class="sc">$</span>osm_polygons) <span class="sc">&gt;</span> <span class="dv">0</span>) playgrounds<span class="sc">$</span>osm_polygons <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  play_pts  <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(playgrounds<span class="sc">$</span>osm_points) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(playgrounds<span class="sc">$</span>osm_points) <span class="sc">&gt;</span> <span class="dv">0</span>) playgrounds<span class="sc">$</span>osm_points <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  playgrounds_sf <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(play_poly)) <span class="fu">st_centroid</span>(play_poly) <span class="cf">else</span> play_pts</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Nature reserves (polygons → centroids)</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  nature <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">opq</span>(bbox_vec) <span class="sc">%&gt;%</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_osm_feature</span>(<span class="at">key =</span> <span class="st">"leisure"</span>, <span class="at">value =</span> <span class="st">"nature_reserve"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">osmdata_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      .<span class="sc">$</span>osm_polygons</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  nature_pts <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(nature) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(nature) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">st_centroid</span>(nature) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Green access status: count of park + playground + nature features</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  n_parks <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(parks_pts)) <span class="dv">0</span> <span class="cf">else</span> <span class="fu">nrow</span>(parks_pts)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  n_play  <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(playgrounds_sf)) <span class="dv">0</span> <span class="cf">else</span> <span class="fu">nrow</span>(playgrounds_sf)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  n_nat   <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(nature_pts)) <span class="dv">0</span> <span class="cf">else</span> <span class="fu">nrow</span>(nature_pts)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  total_green <span class="ot">&lt;-</span> n_parks <span class="sc">+</span> n_play <span class="sc">+</span> n_nat</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Thresholds from map_config (or defaults if not loaded)</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  th <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"map_config"</span>)) map_config<span class="sc">$</span>green<span class="sc">$</span>thresholds <span class="cf">else</span> <span class="fu">c</span>(<span class="at">great =</span> <span class="dv">20</span>L, <span class="at">good =</span> <span class="dv">5</span>L, <span class="at">limited =</span> <span class="dv">1</span>L)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  green_status <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    total_green <span class="sc">&gt;=</span> th[<span class="st">"great"</span>]   <span class="sc">~</span> <span class="st">"Great"</span>,</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    total_green <span class="sc">&gt;=</span> th[<span class="st">"good"</span>]   <span class="sc">~</span> <span class="st">"Good"</span>,</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    total_green <span class="sc">&gt;=</span> th[<span class="st">"limited"</span>] <span class="sc">~</span> <span class="st">"Limited"</span>,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span>                         <span class="sc">~</span> <span class="st">"None"</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">green_status =</span> green_status,</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">parks_sf =</span> parks_pts,</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">playgrounds_sf =</span> playgrounds_sf,</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">nature_reserves_sf =</span> nature_pts,</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_parks =</span> n_parks,</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_playgrounds =</span> n_play,</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_nature =</span> n_nat</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="script-build-ses-index" class="level2">
<h2 class="anchored" data-anchor-id="script-build-ses-index">build_ses_index.R</h2>
<p><strong>What it does:</strong> Builds the income/SES GeoPackage from Statistics Canada 2021 Census and DA boundaries. Reads census CSV(s) and boundary shapefiles from data/raw/, joins on DA code, computes median household income and optional SES index (mean ± SD bands), and writes data/ses_index.gpkg. Supports test mode (one region, limited rows). Run after fetch_statcan_census.py (or equivalent) has downloaded and extracted census and boundaries.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build SES (socioeconomic status) index from Statistics Canada 2021 Census</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and DA boundaries. Reads data/raw/ census CSV and data/raw/da_boundaries/,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># joins, computes index, writes data/ses_index.gpkg.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: tidyverse, sf. Run after scripts/fetch_statcan_census.py.</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Test mode (faster for debugging): set env var SES_INDEX_TEST=true before sourcing,</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   or in R: Sys.setenv(SES_INDEX_TEST = "true"); source("R/build_ses_index.R")</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   Uses 1 region only, limits census rows to 200k, output: ses_index_test.gpkg</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">dir.exists</span>(<span class="st">"R"</span>)) <span class="fu">source</span>(<span class="st">"R/map_config.R"</span>) <span class="cf">else</span> <span class="fu">source</span>(<span class="st">"map_config.R"</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Test mode: 1 region, limit rows, write to ses_index_test.gpkg</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>TEST_MODE <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">Sys.getenv</span>(<span class="st">"SES_INDEX_TEST"</span>, <span class="st">""</span>)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"true"</span>, <span class="st">"1"</span>, <span class="st">"yes"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>N_MAX_CENSUS <span class="ot">&lt;-</span> <span class="cf">if</span> (TEST_MODE) <span class="dv">200000</span>L <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Paths (relative to project root when run from project root)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>PROJECT_ROOT <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">dir.exists</span>(<span class="st">"data"</span>)) <span class="st">"."</span> <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">dir.exists</span>(<span class="st">"../data"</span>)) <span class="st">".."</span> <span class="cf">else</span> <span class="fu">stop</span>(<span class="st">"Run from project root"</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>RAW_DIR     <span class="ot">&lt;-</span> <span class="fu">file.path</span>(PROJECT_ROOT, <span class="st">"data"</span>, <span class="st">"raw"</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>BOUNDARY_DIR <span class="ot">&lt;-</span> <span class="fu">file.path</span>(RAW_DIR, <span class="st">"da_boundaries"</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>OUT_GPKG    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(PROJECT_ROOT, <span class="st">"data"</span>, <span class="cf">if</span> (TEST_MODE) <span class="st">"ses_index_test.gpkg"</span> <span class="cf">else</span> <span class="st">"ses_index.gpkg"</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Find boundary shapefile: prefer cartographic (lda_000b*, land-only, no water) over digital (lda_000a*)</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>boundary_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(BOUNDARY_DIR, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.shp$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(boundary_files) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No .shp found in "</span>, BOUNDARY_DIR, <span class="st">". Run fetch_statcan_census.py --boundaries first."</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>carto <span class="ot">&lt;-</span> boundary_files[<span class="fu">grepl</span>(<span class="st">"000b21|cartographic"</span>, <span class="fu">basename</span>(boundary_files), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>boundary_path <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(carto) <span class="sc">&gt;</span> <span class="dv">0</span>) carto[<span class="dv">1</span>] <span class="cf">else</span> boundary_files[<span class="dv">1</span>]</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(carto) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">message</span>(<span class="st">"Using digital boundaries. For land-only (no water) use cartographic: python scripts/fetch_statcan_census.py --boundaries (downloads lda_000b21a_e)."</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Find census CSV: prefer census_profile_*.csv (after Python extract), or *CSV_data*.csv in raw/ subdirs</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>census_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(RAW_DIR, <span class="at">pattern =</span> <span class="st">"census_profile.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Skip files that are actually ZIPs (StatCan returns zip with .csv name)</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>census_files <span class="ot">&lt;-</span> census_files[<span class="fu">vapply</span>(census_files, <span class="cf">function</span>(f) {</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">readBin</span>(f, <span class="st">"raw"</span>, <span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">identical</span>(h, <span class="fu">charToRaw</span>(<span class="st">"PK"</span>))</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>}, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(census_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  census_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(RAW_DIR, <span class="at">pattern =</span> <span class="st">".*CSV_data.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  census_files <span class="ot">&lt;-</span> census_files[<span class="fu">vapply</span>(census_files, <span class="cf">function</span>(f) {</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    h <span class="ot">&lt;-</span> <span class="fu">readBin</span>(f, <span class="st">"raw"</span>, <span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">identical</span>(h, <span class="fu">charToRaw</span>(<span class="st">"PK"</span>))</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>  }, <span class="fu">logical</span>(<span class="dv">1</span>))]</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(census_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"No valid census CSV in "</span>, RAW_DIR, <span class="st">". StatCan returns ZIP: re-run fetch_statcan_census.py to download and extract, or extract the ZIP and place the inner CSV in data/raw/."</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (TEST_MODE) {</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  census_files <span class="ot">&lt;-</span> census_files[<span class="dv">1</span>]</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"TEST MODE: using 1 region only, n_max = "</span>, N_MAX_CENSUS, <span class="st">", output: "</span>, <span class="fu">basename</span>(OUT_GPKG))</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Using census file(s): "</span>, <span class="fu">paste</span>(<span class="fu">basename</span>(census_files), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Reading boundaries from: "</span>, boundary_path)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>boundaries <span class="ot">&lt;-</span> <span class="fu">st_read</span>(boundary_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>id_col <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">c</span>(<span class="st">"DGUID"</span>, <span class="st">"DAUID"</span>, <span class="st">"dguid"</span>, <span class="st">"dauid"</span>), <span class="fu">names</span>(boundaries))[<span class="dv">1</span>]</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(id_col)) id_col <span class="ot">&lt;-</span> <span class="fu">names</span>(boundaries)[<span class="dv">1</span>]</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Using geography ID column: "</span>, id_col)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a><span class="co"># StatCan 2021 Census Profile: 1 = Total population; 243 = Median total income of household in 2020 ($), value in C1_COUNT_TOTAL</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="co"># If your CSV uses a different ID, set INCOME_CHAR_ID: Sys.setenv(INCOME_CHAR_ID = "2151"); source("R/build_ses_index.R")</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>INCOME_CHAR_ID <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">Sys.getenv</span>(<span class="st">"INCOME_CHAR_ID"</span>, <span class="st">"243"</span>))</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>read_census_safe <span class="ot">&lt;-</span> <span class="cf">function</span>(path, <span class="at">n_max =</span> <span class="cn">Inf</span>) {</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressMessages</span>({</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>, <span class="at">guess_max =</span> <span class="dv">10000</span>, <span class="at">n_max =</span> n_max)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  d</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>census_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(census_files, <span class="cf">function</span>(f) <span class="fu">read_census_safe</span>(f, <span class="at">n_max =</span> N_MAX_CENSUS))</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>census_raw  <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(census_list)</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect long vs wide format</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>is_long <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"GEO_LEVEL"</span>, <span class="st">"CHARACTERISTIC_ID"</span>, <span class="st">"DGUID"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(census_raw)) <span class="sc">&amp;&amp;</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>  (<span class="st">"C10_RATE_TOTAL"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_raw) <span class="sc">||</span> <span class="st">"C1_COUNT_TOTAL"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_raw))</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (is_long) {</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Detected long-format Census Profile; filtering to DAs, population and median household income."</span>)</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>  has_count <span class="ot">&lt;-</span> <span class="st">"C1_COUNT_TOTAL"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_raw)</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  has_rate  <span class="ot">&lt;-</span> <span class="st">"C10_RATE_TOTAL"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_raw)</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Median household income may be in C1_COUNT_TOTAL (dollar value) or a rate column depending on product</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  alt_geo_col <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">c</span>(<span class="st">"ALT_GEO_CODE"</span>, <span class="st">"ALT GEO CODE"</span>), <span class="fu">names</span>(census_raw))[<span class="dv">1</span>]</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(alt_geo_col)) alt_geo_col <span class="ot">&lt;-</span> <span class="fu">names</span>(census_raw)[<span class="fu">grep</span>(<span class="st">"ALT.*GEO|GEO_CODE"</span>, <span class="fu">names</span>(census_raw), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)][<span class="dv">1</span>]</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>  char_ids <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"1"</span>, INCOME_CHAR_ID)</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>  census_da <span class="ot">&lt;-</span> census_raw <span class="sc">%&gt;%</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(GEO_LEVEL <span class="sc">==</span> <span class="st">"Dissemination area"</span>, <span class="fu">as.character</span>(CHARACTERISTIC_ID) <span class="sc">%in%</span> char_ids) <span class="sc">%&gt;%</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">dguid_join =</span> <span class="fu">as.character</span>(<span class="fu">trimws</span>(DGUID)),</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">dauid_join =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(alt_geo_col)) <span class="fu">as.character</span>(<span class="fu">trimws</span>(.data[[alt_geo_col]])) <span class="cf">else</span> <span class="cn">NA_character_</span>,</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">value_num =</span> <span class="fu">suppressWarnings</span>(</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (has_count <span class="sc">&amp;&amp;</span> has_rate) {</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>          <span class="fu">if_else</span>(<span class="fu">as.character</span>(CHARACTERISTIC_ID) <span class="sc">==</span> <span class="st">"1"</span>, <span class="fu">as.numeric</span>(.data[[<span class="st">"C1_COUNT_TOTAL"</span>]]), <span class="fu">as.numeric</span>(.data[[<span class="st">"C1_COUNT_TOTAL"</span>]]))</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (has_count) {</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>          <span class="fu">as.numeric</span>(.data[[<span class="st">"C1_COUNT_TOTAL"</span>]])</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>          <span class="fu">as.numeric</span>(.data[[<span class="st">"C10_RATE_TOTAL"</span>]])</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dguid_join), dguid_join <span class="sc">!=</span> <span class="st">""</span>)</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>  census_slim <span class="ot">&lt;-</span> census_da <span class="sc">%&gt;%</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(dguid_join) <span class="sc">%&gt;%</span></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dauid_join =</span> <span class="fu">first</span>(dauid_join)) <span class="sc">%&gt;%</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(dguid_join, dauid_join, CHARACTERISTIC_ID, value_num) <span class="sc">%&gt;%</span></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> CHARACTERISTIC_ID, <span class="at">values_from =</span> value_num, <span class="at">names_prefix =</span> <span class="st">"char_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">population =</span> <span class="cf">if</span> (<span class="st">"char_1"</span> <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.data[[<span class="st">"char_1"</span>]])) <span class="cf">else</span> <span class="cn">NA_real_</span>,</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">income_raw =</span> <span class="cf">if</span> (<span class="fu">paste0</span>(<span class="st">"char_"</span>, INCOME_CHAR_ID) <span class="sc">%in%</span> <span class="fu">names</span>(.)) <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.data[[<span class="fu">paste0</span>(<span class="st">"char_"</span>, INCOME_CHAR_ID)]])) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(dguid_join, dauid_join, population, income_raw)</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">is.na</span>(census_slim<span class="sc">$</span>income_raw))) {</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Median household income (CHARACTERISTIC_ID "</span>, INCOME_CHAR_ID, <span class="st">") not found or all NA. Confirm CHARACTERISTIC_ID in your Census Profile (e.g. 243); set INCOME_CHAR_ID if different."</span>)</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">is.na</span>(census_slim<span class="sc">$</span>dauid_join)) <span class="sc">||</span> <span class="fu">all</span>(<span class="fu">trimws</span>(census_slim<span class="sc">$</span>dauid_join) <span class="sc">==</span> <span class="st">""</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>    census_slim <span class="ot">&lt;-</span> census_slim <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">dauid_join =</span> <span class="fu">str_sub</span>(dguid_join, <span class="sc">-</span><span class="dv">8</span>, <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>  census_slim <span class="ot">&lt;-</span> census_slim <span class="sc">%&gt;%</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dauid_join_raw =</span> <span class="fu">trimws</span>(<span class="fu">replace_na</span>(dauid_join, <span class="st">""</span>)),</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>           <span class="at">dauid_join =</span> <span class="fu">str_pad</span>(dauid_join_raw, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">side =</span> <span class="st">"left"</span>, <span class="at">pad =</span> <span class="st">"0"</span>))</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>  census_id_col <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">c</span>(<span class="st">"DGUID"</span>, <span class="st">"GEO_CODE"</span>, <span class="st">"dguid"</span>), <span class="fu">names</span>(census_raw))[<span class="dv">1</span>]</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(census_id_col)) census_id_col <span class="ot">&lt;-</span> <span class="fu">names</span>(census_raw)[<span class="dv">1</span>]</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"GEO_LEVEL"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_raw)) {</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>    census_da <span class="ot">&lt;-</span> census_raw <span class="sc">%&gt;%</span> <span class="fu">filter</span>(GEO_LEVEL <span class="sc">==</span> <span class="dv">4</span> <span class="sc">|</span> GEO_LEVEL <span class="sc">==</span> <span class="dv">5</span> <span class="sc">|</span> GEO_LEVEL <span class="sc">==</span> <span class="st">"Dissemination area"</span>)</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    census_da <span class="ot">&lt;-</span> census_raw</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>  find_col <span class="ot">&lt;-</span> <span class="cf">function</span>(df, patterns) {</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>    nms <span class="ot">&lt;-</span> <span class="fu">names</span>(df)</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (p <span class="cf">in</span> patterns) {</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">&lt;-</span> <span class="fu">grep</span>(p, nms, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(idx) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">return</span>(nms[idx[<span class="dv">1</span>]])</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA_character_</span></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>  col_income <span class="ot">&lt;-</span> <span class="fu">find_col</span>(census_da, <span class="fu">c</span>(<span class="st">"Median total income of household"</span>, <span class="st">"Median household income"</span>, <span class="st">"Median total income"</span>, <span class="st">"Median income"</span>))</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>  cols_keep <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(census_id_col, col_income))</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>  cols_keep <span class="ot">&lt;-</span> <span class="fu">intersect</span>(cols_keep, <span class="fu">names</span>(census_da))</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(cols_keep) <span class="sc">&lt;</span> <span class="dv">2</span>) cols_keep <span class="ot">&lt;-</span> <span class="fu">names</span>(census_da)[<span class="fu">seq_len</span>(<span class="fu">min</span>(<span class="dv">3</span>, <span class="fu">ncol</span>(census_da)))]</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>  census_slim <span class="ot">&lt;-</span> census_da <span class="sc">%&gt;%</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">any_of</span>(cols_keep)) <span class="sc">%&gt;%</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dguid_join =</span> <span class="fu">as.character</span>(.data[[census_id_col]]))</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (c <span class="cf">in</span> <span class="fu">setdiff</span>(cols_keep, census_id_col)) {</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (c <span class="sc">%in%</span> <span class="fu">names</span>(census_slim)) census_slim[[c]] <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(census_slim[[c]]))</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>  census_slim <span class="ot">&lt;-</span> census_slim <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dguid_join) <span class="sc">&amp;</span> dguid_join <span class="sc">!=</span> <span class="st">""</span>)</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>  inc_col <span class="ot">&lt;-</span> <span class="cf">if</span> (col_income <span class="sc">%in%</span> <span class="fu">names</span>(census_slim)) col_income <span class="cf">else</span> <span class="fu">names</span>(census_slim)[<span class="fu">sapply</span>(census_slim, is.numeric)][<span class="dv">1</span>]</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>  census_slim <span class="ot">&lt;-</span> census_slim <span class="sc">%&gt;%</span></span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">dauid_join =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">dauid_join_raw =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>      <span class="at">population =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>      <span class="at">income_raw =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(inc_col)) .data[[inc_col]] <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(dguid_join, dauid_join, dauid_join_raw, population, income_raw)</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Income: use raw median household income ($). Classify by study-area mean ± SD (same logic as before).</span></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep income_raw as-is; bivariate map uses it for ±1 SD Low/Med/High. idx_st is the 5-category status (Lowest/.../Highest) from map_config for reference.</span></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>ref <span class="ot">&lt;-</span> census_slim <span class="sc">%&gt;%</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">m_inc =</span> <span class="fu">mean</span>(income_raw, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">s_inc =</span> <span class="fu">sd</span>(income_raw, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>ref <span class="ot">&lt;-</span> ref <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">s_inc =</span> <span class="fu">replace_na</span>(s_inc, <span class="dv">0</span>))</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (ref<span class="sc">$</span>s_inc <span class="sc">==</span> <span class="dv">0</span>) ref<span class="sc">$</span>s_inc <span class="ot">&lt;-</span> <span class="fl">1e-9</span></span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>lab <span class="ot">&lt;-</span> map_config<span class="sc">$</span>ses<span class="sc">$</span>labels</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>m   <span class="ot">&lt;-</span> map_config<span class="sc">$</span>ses<span class="sc">$</span>sd_multipliers</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>census_slim <span class="ot">&lt;-</span> census_slim <span class="sc">%&gt;%</span></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">ses_idx =</span> income_raw,</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">idx_st =</span> <span class="fu">case_when</span>(</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(income_raw) <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>      income_raw <span class="sc">&lt;</span> ref<span class="sc">$</span>m_inc <span class="sc">+</span> m[<span class="dv">1</span>] <span class="sc">*</span> ref<span class="sc">$</span>s_inc <span class="sc">~</span> lab[<span class="dv">1</span>],</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>      income_raw <span class="sc">&lt;</span> ref<span class="sc">$</span>m_inc <span class="sc">+</span> m[<span class="dv">2</span>] <span class="sc">*</span> ref<span class="sc">$</span>s_inc <span class="sc">~</span> lab[<span class="dv">2</span>],</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>      income_raw <span class="sc">&lt;=</span> ref<span class="sc">$</span>m_inc <span class="sc">+</span> m[<span class="dv">3</span>] <span class="sc">*</span> ref<span class="sc">$</span>s_inc <span class="sc">~</span> lab[<span class="dv">3</span>],</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>      income_raw <span class="sc">&lt;=</span> ref<span class="sc">$</span>m_inc <span class="sc">+</span> m[<span class="dv">4</span>] <span class="sc">*</span> ref<span class="sc">$</span>s_inc <span class="sc">~</span> lab[<span class="dv">4</span>],</span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> lab[<span class="dv">5</span>]</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Join to boundaries. Per StatCan DGUID definition (92F0138M): for DA, DGUID = VVVV+T+SSSS+DAUID</span></span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a><span class="co"># (9 fixed chars + 8-char DAUID). Shapefile .dbf often truncates DGUID to 10 chars, so full-DGUID</span></span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a><span class="co"># join fails; use last 8 of census DGUID = boundary DAUID as the canonical fallback.</span></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www150.statcan.gc.ca/n1/pub/92f0138m/92f0138m2019001-eng.htm</span></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>boundary_has_dguid <span class="ot">&lt;-</span> <span class="st">"DGUID"</span> <span class="sc">%in%</span> <span class="fu">names</span>(boundaries)</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>boundary_has_dauid <span class="ot">&lt;-</span> <span class="st">"DAUID"</span> <span class="sc">%in%</span> <span class="fu">names</span>(boundaries)</span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>census_slim<span class="sc">$</span>dguid_suffix8 <span class="ot">&lt;-</span> <span class="fu">str_sub</span>(census_slim<span class="sc">$</span>dguid_join, <span class="sc">-</span><span class="dv">8</span>, <span class="sc">-</span><span class="dv">1</span>)  <span class="co"># last 8 = DAUID per StatCan</span></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>ses_sf <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (boundary_has_dguid) {</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>  ses_sf <span class="ot">&lt;-</span> boundaries <span class="sc">%&gt;%</span></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dguid_join =</span> <span class="fu">as.character</span>(DGUID)) <span class="sc">%&gt;%</span></span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(census_slim <span class="sc">%&gt;%</span> <span class="fu">select</span>(dguid_join, population, income_raw, ses_idx, idx_st),</span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>               <span class="at">by =</span> <span class="st">"dguid_join"</span>)</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(ses_sf) <span class="sc">||</span> <span class="fu">nrow</span>(ses_sf) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> boundary_has_dauid) {</span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"DGUID join produced 0 rows; trying last 8 of DGUID = DAUID (per StatCan 92F0138M)."</span>)</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>  bbox_join <span class="ot">&lt;-</span> boundaries <span class="sc">%&gt;%</span></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dauid_8 =</span> <span class="fu">str_pad</span>(<span class="fu">trimws</span>(<span class="fu">as.character</span>(DAUID)), <span class="at">width =</span> <span class="dv">8</span>, <span class="at">side =</span> <span class="st">"left"</span>, <span class="at">pad =</span> <span class="st">"0"</span>))</span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>  ses_sf <span class="ot">&lt;-</span> bbox_join <span class="sc">%&gt;%</span></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(census_slim <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="at">dauid_8 =</span> dguid_suffix8, population, income_raw, ses_idx, idx_st),</span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>               <span class="at">by =</span> <span class="st">"dauid_8"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>dauid_8)</span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(ses_sf) <span class="sc">||</span> <span class="fu">nrow</span>(ses_sf) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> boundary_has_dauid <span class="sc">&amp;&amp;</span> <span class="st">"dauid_join"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_slim)) {</span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"DAUID-from-DGUID join had 0 rows; trying census ALT_GEO_CODE as DAUID."</span>)</span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a>  bbox_join <span class="ot">&lt;-</span> boundaries <span class="sc">%&gt;%</span></span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dauid_join =</span> <span class="fu">str_pad</span>(<span class="fu">trimws</span>(<span class="fu">as.character</span>(DAUID)), <span class="at">width =</span> <span class="dv">8</span>, <span class="at">side =</span> <span class="st">"left"</span>, <span class="at">pad =</span> <span class="st">"0"</span>))</span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>  ses_sf <span class="ot">&lt;-</span> bbox_join <span class="sc">%&gt;%</span></span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(census_slim <span class="sc">%&gt;%</span> <span class="fu">select</span>(dauid_join, population, income_raw, ses_idx, idx_st),</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>               <span class="at">by =</span> <span class="st">"dauid_join"</span>)</span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(ses_sf) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="st">"dauid_join_raw"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_slim)) {</span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Padded DAUID join had 0 rows; trying raw DAUID (no zero-pad)."</span>)</span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>    bbox_join2 <span class="ot">&lt;-</span> boundaries <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">dauid_join =</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(DAUID)))</span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>    census_join2 <span class="ot">&lt;-</span> census_slim <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dauid_join_raw <span class="sc">!=</span> <span class="st">""</span>)</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(census_join2) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>      ses_sf <span class="ot">&lt;-</span> bbox_join2 <span class="sc">%&gt;%</span></span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>        <span class="fu">inner_join</span>(census_join2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="at">dauid_join =</span> dauid_join_raw, population, income_raw, ses_idx, idx_st),</span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a>                   <span class="at">by =</span> <span class="st">"dauid_join"</span>)</span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(ses_sf) <span class="sc">||</span> <span class="fu">nrow</span>(ses_sf) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true" tabindex="-1"></a>  <span class="co"># One more try: match last 8 chars of census DGUID to any boundary ID-like column (e.g. DAUID with different name)</span></span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true" tabindex="-1"></a>  id_like <span class="ot">&lt;-</span> <span class="fu">names</span>(boundaries)[<span class="fu">grepl</span>(<span class="st">"UID|GUID|ID"</span>, <span class="fu">names</span>(boundaries), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (bcol <span class="cf">in</span> id_like) {</span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>bcol <span class="sc">%in%</span> <span class="fu">names</span>(boundaries)) <span class="cf">next</span></span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true" tabindex="-1"></a>    bvals <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(boundaries[[bcol]]))</span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">nchar</span>(bvals) <span class="sc">&gt;=</span> <span class="dv">6</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="cf">next</span></span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true" tabindex="-1"></a>    try_join <span class="ot">&lt;-</span> boundaries <span class="sc">%&gt;%</span></span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">join_try =</span> .data[[bcol]]) <span class="sc">%&gt;%</span></span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">join_try =</span> <span class="fu">trimws</span>(<span class="fu">as.character</span>(join_try))) <span class="sc">%&gt;%</span></span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(census_slim <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="at">join_try =</span> dguid_suffix8, population, income_raw, ses_idx, idx_st), <span class="at">by =</span> <span class="st">"join_try"</span>)</span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(try_join) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true" tabindex="-1"></a>      ses_sf <span class="ot">&lt;-</span> try_join <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>join_try)</span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Join succeeded using census DGUID (last 8 chars) = boundary '"</span>, bcol, <span class="st">"'."</span>)</span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-251"><a href="#cb6-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-252"><a href="#cb6-252" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(ses_sf) <span class="sc">||</span> <span class="fu">nrow</span>(ses_sf) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb6-253"><a href="#cb6-253" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detect ADA vs DA: census is DA (DGUID schema 0512); boundaries may be ADA (schema 0516, has ADAUID, no DAUID)</span></span>
<span id="cb6-254"><a href="#cb6-254" aria-hidden="true" tabindex="-1"></a>  boundary_dguid_sample <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="st">"DGUID"</span> <span class="sc">%in%</span> <span class="fu">names</span>(boundaries)) <span class="fu">head</span>(<span class="fu">trimws</span>(<span class="fu">as.character</span>(boundaries<span class="sc">$</span>DGUID)), <span class="dv">1</span>) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb6-255"><a href="#cb6-255" aria-hidden="true" tabindex="-1"></a>  census_dguid_sample   <span class="ot">&lt;-</span> <span class="fu">head</span>(census_slim<span class="sc">$</span>dguid_join, <span class="dv">1</span>)</span>
<span id="cb6-256"><a href="#cb6-256" aria-hidden="true" tabindex="-1"></a>  boundary_is_ada <span class="ot">&lt;-</span> (<span class="st">"ADAUID"</span> <span class="sc">%in%</span> <span class="fu">names</span>(boundaries) <span class="sc">&amp;&amp;</span> <span class="sc">!</span>(<span class="st">"DAUID"</span> <span class="sc">%in%</span> <span class="fu">names</span>(boundaries))) <span class="sc">||</span></span>
<span id="cb6-257"><a href="#cb6-257" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">nchar</span>(boundary_dguid_sample) <span class="sc">&gt;=</span> <span class="dv">9</span> <span class="sc">&amp;&amp;</span> <span class="fu">grepl</span>(<span class="st">"0516"</span>, <span class="fu">substr</span>(boundary_dguid_sample, <span class="dv">1</span>, <span class="dv">9</span>)))</span>
<span id="cb6-258"><a href="#cb6-258" aria-hidden="true" tabindex="-1"></a>  census_is_da   <span class="ot">&lt;-</span> <span class="fu">nchar</span>(census_dguid_sample) <span class="sc">&gt;=</span> <span class="dv">9</span> <span class="sc">&amp;&amp;</span> <span class="fu">grepl</span>(<span class="st">"0512"</span>, <span class="fu">substr</span>(census_dguid_sample, <span class="dv">1</span>, <span class="dv">9</span>))</span>
<span id="cb6-259"><a href="#cb6-259" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (boundary_is_ada <span class="sc">&amp;&amp;</span> census_is_da) {</span>
<span id="cb6-260"><a href="#cb6-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(</span>
<span id="cb6-261"><a href="#cb6-261" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Boundary file is Aggregate Dissemination Area (ADA), but census data is Dissemination Area (DA). "</span>,</span>
<span id="cb6-262"><a href="#cb6-262" aria-hidden="true" tabindex="-1"></a>      <span class="st">"You need DA boundaries. Options: (1) Re-download boundaries: python scripts/fetch_statcan_census.py --boundaries "</span>,</span>
<span id="cb6-263"><a href="#cb6-263" aria-hidden="true" tabindex="-1"></a>      <span class="st">"(then replace contents of data/raw/da_boundaries/ with the new DA shapefile), or "</span>,</span>
<span id="cb6-264"><a href="#cb6-264" aria-hidden="true" tabindex="-1"></a>      <span class="st">"(2) Download the Dissemination Area boundary file (lda_000b21a_e.zip cartographic recommended) from StatCan catalogue 92-169-X2021001 "</span>,</span>
<span id="cb6-265"><a href="#cb6-265" aria-hidden="true" tabindex="-1"></a>      <span class="st">"and extract it into data/raw/da_boundaries/."</span></span>
<span id="cb6-266"><a href="#cb6-266" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-267"><a href="#cb6-267" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-268"><a href="#cb6-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"=== Join failed. Diagnostics ==="</span>)</span>
<span id="cb6-269"><a href="#cb6-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Boundary columns: "</span>, <span class="fu">paste</span>(<span class="fu">names</span>(boundaries), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb6-270"><a href="#cb6-270" aria-hidden="true" tabindex="-1"></a>  id_like_diag <span class="ot">&lt;-</span> <span class="fu">names</span>(boundaries)[<span class="fu">grepl</span>(<span class="st">"UID|GUID|ID"</span>, <span class="fu">names</span>(boundaries), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb6-271"><a href="#cb6-271" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (c <span class="cf">in</span> id_like_diag) {</span>
<span id="cb6-272"><a href="#cb6-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  Boundary "</span>, c, <span class="st">" (first 3): "</span>, <span class="fu">paste</span>(<span class="fu">head</span>(<span class="fu">unique</span>(<span class="fu">as.character</span>(boundaries[[c]])), <span class="dv">3</span>), <span class="at">collapse =</span> <span class="st">" | "</span>))</span>
<span id="cb6-273"><a href="#cb6-273" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-274"><a href="#cb6-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Census dguid_join (first 3): "</span>, <span class="fu">paste</span>(<span class="fu">head</span>(<span class="fu">unique</span>(census_slim<span class="sc">$</span>dguid_join), <span class="dv">3</span>), <span class="at">collapse =</span> <span class="st">" | "</span>))</span>
<span id="cb6-275"><a href="#cb6-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Census dauid_join (first 3): "</span>, <span class="fu">paste</span>(<span class="fu">head</span>(<span class="fu">unique</span>(census_slim<span class="sc">$</span>dauid_join), <span class="dv">3</span>), <span class="at">collapse =</span> <span class="st">" | "</span>))</span>
<span id="cb6-276"><a href="#cb6-276" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"dauid_join_raw"</span> <span class="sc">%in%</span> <span class="fu">names</span>(census_slim)) <span class="fu">message</span>(<span class="st">"Census dauid_join_raw (first 3): "</span>, <span class="fu">paste</span>(<span class="fu">head</span>(<span class="fu">unique</span>(census_slim<span class="sc">$</span>dauid_join_raw), <span class="dv">3</span>), <span class="at">collapse =</span> <span class="st">" | "</span>))</span>
<span id="cb6-277"><a href="#cb6-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Census dguid_suffix8 (first 3): "</span>, <span class="fu">paste</span>(<span class="fu">head</span>(<span class="fu">unique</span>(census_slim<span class="sc">$</span>dguid_suffix8), <span class="dv">3</span>), <span class="at">collapse =</span> <span class="st">" | "</span>))</span>
<span id="cb6-278"><a href="#cb6-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Join produced 0 rows. Census and boundary IDs do not match. See diagnostics above."</span>)</span>
<span id="cb6-279"><a href="#cb6-279" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-280"><a href="#cb6-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-281"><a href="#cb6-281" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Writing "</span>, <span class="fu">nrow</span>(ses_sf), <span class="st">" DAs to "</span>, OUT_GPKG)</span>
<span id="cb6-282"><a href="#cb6-282" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">dirname</span>(OUT_GPKG), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-283"><a href="#cb6-283" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(ses_sf, OUT_GPKG, <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-284"><a href="#cb6-284" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Done: "</span>, OUT_GPKG)</span>
<span id="cb6-285"><a href="#cb6-285" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (TEST_MODE) <span class="fu">message</span>(<span class="st">"(Test mode. For full Canada, unset SES_INDEX_TEST and re-run.)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="script-process-bbox" class="level2">
<h2 class="anchored" data-anchor-id="script-process-bbox">process_bbox.R</h2>
<p><strong>What it does:</strong> Resolves the study-area bounding box (from city name via osmdata::getbb, custom_bbox, or amalgamation_cities_list), optionally expands it by custom_distance_km, clips the income GeoPackage to the bbox, and writes clipped polygons to data/clipped_income/. Caches clipped layer by bbox UID in data/cache.gpkg. Returns bbox matrix and paths needed by create_bivariate_map.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process bounding box and clip income layer to study area.</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Uses income_gpkg (path to income GeoPackage, e.g. data/ses_index.gpkg or data/income.gpkg), writes to data/clipped_income/.</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Caches clipped layer by bbox UID in data/cache.gpkg (layer clipped_income) when available.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geosphere)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(osmdata)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">dir.exists</span>(<span class="st">"R"</span>)) <span class="fu">source</span>(<span class="st">"R/cache_utils.R"</span>) <span class="cf">else</span> <span class="fu">source</span>(<span class="st">"cache_utils.R"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>process_bbox <span class="ot">&lt;-</span> <span class="cf">function</span>(study_area, income_gpkg, <span class="at">amalgamation_cities_list =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">city_pr =</span> <span class="cn">NULL</span>, <span class="at">custom_bbox =</span> <span class="cn">NULL</span>, <span class="at">custom_distance_km =</span> <span class="dv">0</span>) {</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  income_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(income_gpkg, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fix invalid polygons (e.g. duplicate vertices) so st_intersection doesn't fail</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">st_is_valid</span>(income_sf))) {</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    income_sf <span class="ot">&lt;-</span> <span class="fu">st_make_valid</span>(income_sf)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  expand_bbox <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, distance_km) {</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    lat_expansion <span class="ot">&lt;-</span> distance_km <span class="sc">/</span> <span class="fl">111.32</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    centroid_lat <span class="ot">&lt;-</span> (bbox[<span class="st">"y"</span>, <span class="st">"min"</span>] <span class="sc">+</span> bbox[<span class="st">"y"</span>, <span class="st">"max"</span>]) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    lon_expansion <span class="ot">&lt;-</span> distance_km <span class="sc">/</span> (<span class="fl">111.32</span> <span class="sc">*</span> <span class="fu">cos</span>(centroid_lat <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">180</span>))</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        bbox[<span class="st">"x"</span>, <span class="st">"min"</span>] <span class="sc">-</span> lon_expansion,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        bbox[<span class="st">"y"</span>, <span class="st">"min"</span>] <span class="sc">-</span> lat_expansion,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        bbox[<span class="st">"x"</span>, <span class="st">"max"</span>] <span class="sc">+</span> lon_expansion,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        bbox[<span class="st">"y"</span>, <span class="st">"max"</span>] <span class="sc">+</span> lat_expansion</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="fu">c</span>(<span class="st">"min"</span>, <span class="st">"max"</span>))</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(custom_bbox)) {</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(custom_bbox) <span class="sc">!=</span> <span class="dv">4</span>) <span class="fu">stop</span>(<span class="st">"custom_bbox must be c(xmin, ymin, xmax, ymax)"</span>)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    bbox <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(custom_bbox[<span class="dv">1</span>], custom_bbox[<span class="dv">2</span>], custom_bbox[<span class="dv">3</span>], custom_bbox[<span class="dv">4</span>]),</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="fu">c</span>(<span class="st">"min"</span>, <span class="st">"max"</span>))</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(city_pr)) {</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Processing multiple cities (city_pr) is not supported with automatic bbox saving."</span>)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(amalgamation_cities_list)) {</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    bboxes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(amalgamation_cities_list, getbb)</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    bbox <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">min</span>(<span class="fu">sapply</span>(bboxes, <span class="cf">function</span>(bb) bb[<span class="st">"x"</span>, <span class="st">"min"</span>])),</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">min</span>(<span class="fu">sapply</span>(bboxes, <span class="cf">function</span>(bb) bb[<span class="st">"y"</span>, <span class="st">"min"</span>])),</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">max</span>(<span class="fu">sapply</span>(bboxes, <span class="cf">function</span>(bb) bb[<span class="st">"x"</span>, <span class="st">"max"</span>])),</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        <span class="fu">max</span>(<span class="fu">sapply</span>(bboxes, <span class="cf">function</span>(bb) bb[<span class="st">"y"</span>, <span class="st">"max"</span>]))</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="fu">c</span>(<span class="st">"min"</span>, <span class="st">"max"</span>))</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    bbox <span class="ot">&lt;-</span> <span class="fu">getbb</span>(study_area)</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (custom_distance_km <span class="sc">&gt;</span> <span class="dv">0</span>) bbox <span class="ot">&lt;-</span> <span class="fu">expand_bbox</span>(bbox, custom_distance_km)</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assign</span>(<span class="st">"expanded_bbox"</span>, bbox, <span class="at">envir =</span> .GlobalEnv)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>  modified_text <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(study_area)) {</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace_all</span>(<span class="fu">str_extract</span>(study_area, <span class="st">"^[^,]+"</span>), <span class="st">" "</span>, <span class="st">"_"</span>)</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"custom_bbox"</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">dirname</span>(income_gpkg), <span class="st">"clipped_income"</span>)</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  out_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">paste0</span>(modified_text, <span class="st">".gpkg"</span>))</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use cached clipped layer for this bbox when available</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  cached_clip <span class="ot">&lt;-</span> <span class="fu">get_cached_clipped_income</span>(bbox)</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cached_clip) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(cached_clip) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(cached_clip, out_path, <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Using cached clipped income for this bbox."</span>)</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(bbox)</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>  bbox_polygon <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(<span class="fu">st_bbox</span>(</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="at">xmin =</span> bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], <span class="at">ymin =</span> bbox[<span class="st">"y"</span>, <span class="st">"min"</span>], <span class="at">xmax =</span> bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], <span class="at">ymax =</span> bbox[<span class="st">"y"</span>, <span class="st">"max"</span>]),</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>  clipped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_intersection</span>(income_sf, bbox_polygon),</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>      <span class="co"># s2 can fail on some boundary geometries; retry using planar (GEOS) intersection</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Retrying clip in planar CRS (s2 failed: "</span>, <span class="fu">conditionMessage</span>(e), <span class="st">")"</span>)</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>      utm_zone <span class="ot">&lt;-</span> <span class="fu">floor</span>((bbox[<span class="st">"x"</span>, <span class="st">"min"</span>] <span class="sc">+</span> bbox[<span class="st">"x"</span>, <span class="st">"max"</span>]) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">180</span>) <span class="sc">%/%</span> <span class="dv">6</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (bbox[<span class="st">"y"</span>, <span class="st">"min"</span>] <span class="sc">+</span> bbox[<span class="st">"y"</span>, <span class="st">"max"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>        crs_planar <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>        crs_planar <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="fu">paste0</span>(<span class="st">"+proj=utm +zone="</span>, utm_zone, <span class="st">" +south +datum=WGS84 +units=m +no_defs"</span>))</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>      income_planar <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(income_sf, crs_planar)</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>      bbox_planar <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(bbox_polygon, crs_planar)</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>      out <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(income_planar, bbox_planar)</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(out, <span class="fu">st_crs</span>(<span class="dv">4326</span>))</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(clipped) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">warning</span>(<span class="st">"Bbox does not intersect any income-layer polygons; clipped layer is empty. Use a larger area or different city."</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(clipped, out_path, <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_cached_clipped_income</span>(bbox, clipped)</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bbox)</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="script-cache-utils" class="level2">
<h2 class="anchored" data-anchor-id="script-cache-utils">cache_utils.R</h2>
<p><strong>What it does:</strong> GeoPackage cache utilities for clipped_income, greenspace, and buffered DAs. <code>bbox_to_uid()</code> generates a stable UID from bbox coordinates; <code>ensure_cache()</code> creates the cache file and empty layers; read/write helpers avoid re-fetching OSM or re-clipping when the same bbox (and buffer) has already been processed. Reduces Overpass load and speeds up repeated runs.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># GeoPackage cache: clipped income (by bbox), greenspace (by bbox), buffered DAs (by bbox + buffer_m).</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cache path: data/cache.gpkg (layers: clipped_income, greenspace, da_buffers).</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># UID is derived only from bbox coordinates (normalized); city is optional metadata.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Default cache path (under project data/)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>CACHE_GPKG <span class="ot">&lt;-</span> <span class="st">"data/cache.gpkg"</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>CACHE_PRECISION <span class="ot">&lt;-</span> <span class="dv">5</span>L  <span class="co"># decimal places for bbox normalization</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generate a stable short UID from a bbox (matrix with x/y min/max or equivalent).</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' Same bbox always yields the same UID; city/label is not used.</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param bbox 2x2 matrix with rownames "x","y" and colnames "min","max", or length-4 vector c(xmin, ymin, xmax, ymax)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return character UID</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>bbox_to_uid <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.matrix</span>(bbox) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>) <span class="sc">%in%</span> <span class="fu">rownames</span>(bbox)) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"min"</span>, <span class="st">"max"</span>) <span class="sc">%in%</span> <span class="fu">colnames</span>(bbox))) {</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    vec <span class="ot">&lt;-</span> <span class="fu">c</span>(bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], bbox[<span class="st">"y"</span>, <span class="st">"min"</span>], bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], bbox[<span class="st">"y"</span>, <span class="st">"max"</span>])</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">is.vector</span>(bbox) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(bbox) <span class="sc">&gt;=</span> <span class="dv">4</span>) {</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    vec <span class="ot">&lt;-</span> bbox[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"bbox must be a 2x2 matrix (x/y, min/max) or length-4 vector c(xmin, ymin, xmax, ymax)"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  vec <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(vec), CACHE_PRECISION)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  key <span class="ot">&lt;-</span> <span class="fu">paste</span>(vec, <span class="at">collapse =</span> <span class="st">"_"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"digest"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">substring</span>(digest<span class="sc">::</span><span class="fu">digest</span>(key, <span class="at">algo =</span> <span class="st">"sha256"</span>), <span class="dv">1</span>L, <span class="dv">16</span>L))</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  key <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^0-9a-zA-Z._-]"</span>, <span class="st">""</span>, key)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nchar</span>(key) <span class="sc">&gt;</span> <span class="dv">64</span>) key <span class="ot">&lt;-</span> <span class="fu">substring</span>(key, <span class="dv">1</span>L, <span class="dv">64</span>L)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  key</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' Ensure cache file and layers exist (creates empty layers if missing).</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>ensure_cache <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">path =</span> CACHE_GPKG) {</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(path)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir)) <span class="fu">dir.create</span>(dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  wgs <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(path)) {</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    empty_geom <span class="ot">&lt;-</span> <span class="fu">st_sfc</span>(<span class="at">crs =</span> wgs)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    empty_green <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">bbox_uid =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmin =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">ymin =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">xmax =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), <span class="at">ymax =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">city =</span> <span class="fu">character</span>(<span class="dv">0</span>), <span class="at">fetched_at =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">geometry =</span> empty_geom</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(empty_green, path, <span class="at">layer =</span> <span class="st">"greenspace"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    empty_buf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">bbox_uid =</span> <span class="fu">character</span>(<span class="dv">0</span>), <span class="at">buffer_m =</span> <span class="fu">integer</span>(<span class="dv">0</span>), <span class="at">city =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">fetched_at =</span> <span class="fu">character</span>(<span class="dv">0</span>), <span class="at">da_row =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">geometry =</span> empty_geom</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(empty_buf, path, <span class="at">layer =</span> <span class="st">"da_buffers"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(path)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="co">#' Read cached merged greenspace for a bbox. Returns sf (one row, WGS84) or NULL if miss.</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>get_cached_greenspace <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, <span class="at">path =</span> CACHE_GPKG) {</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ensure_cache</span>(path)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>  uid <span class="ot">&lt;-</span> <span class="fu">bbox_to_uid</span>(bbox)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"greenspace"</span> <span class="sc">%in%</span> <span class="fu">st_layers</span>(path)<span class="sc">$</span>name) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>  cached <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_read</span>(path, <span class="at">layer =</span> <span class="st">"greenspace"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cached) <span class="sc">||</span> <span class="fu">nrow</span>(cached) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>  hit <span class="ot">&lt;-</span> cached[cached<span class="sc">$</span>bbox_uid <span class="sc">==</span> uid, ]</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(hit) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Geometry column name can be "geom" when read from GeoPackage; use st_geometry to avoid select(geometry) failing</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sf</span>(<span class="at">geometry =</span> <span class="fu">st_geometry</span>(hit), <span class="at">crs =</span> <span class="fu">st_crs</span>(cached))</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="co">#' Write merged greenspace to cache (one row per bbox). merged_sf: single geometry, WGS84 preferred.</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>set_cached_greenspace <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, merged_sf, <span class="at">city =</span> <span class="cn">NULL</span>, <span class="at">path =</span> CACHE_GPKG) {</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ensure_cache</span>(path)</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  uid <span class="ot">&lt;-</span> <span class="fu">bbox_to_uid</span>(bbox)</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.matrix</span>(bbox) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>) <span class="sc">%in%</span> <span class="fu">rownames</span>(bbox)))</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> <span class="fu">c</span>(bbox[<span class="st">"x"</span>, <span class="st">"min"</span>], bbox[<span class="st">"y"</span>, <span class="st">"min"</span>], bbox[<span class="st">"x"</span>, <span class="st">"max"</span>], bbox[<span class="st">"y"</span>, <span class="st">"max"</span>])</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    coords <span class="ot">&lt;-</span> bbox[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>  merged_sf <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(merged_sf, <span class="dv">4326</span>)</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>  row <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">bbox_uid =</span> uid,</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin =</span> coords[<span class="dv">1</span>], <span class="at">ymin =</span> coords[<span class="dv">2</span>], <span class="at">xmax =</span> coords[<span class="dv">3</span>], <span class="at">ymax =</span> coords[<span class="dv">4</span>],</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">city =</span> <span class="fu">as.character</span>(city <span class="sc">%||%</span> <span class="cn">NA_character_</span>),</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">fetched_at =</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>),</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">geometry =</span> <span class="fu">st_geometry</span>(merged_sf),</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>  existing <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">st_read</span>(path, <span class="at">layer =</span> <span class="st">"greenspace"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(existing) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(existing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    existing <span class="ot">&lt;-</span> existing[existing<span class="sc">$</span>bbox_uid <span class="sc">!=</span> uid, ]</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(existing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>      geom_col <span class="ot">&lt;-</span> <span class="fu">attr</span>(existing, <span class="st">"sf_column"</span>)</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (geom_col <span class="sc">!=</span> <span class="st">"geometry"</span>) {</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(existing)[<span class="fu">names</span>(existing) <span class="sc">==</span> geom_col] <span class="ot">&lt;-</span> <span class="st">"geometry"</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>        <span class="fu">attr</span>(existing, <span class="st">"sf_column"</span>) <span class="ot">&lt;-</span> <span class="st">"geometry"</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>      existing <span class="ot">&lt;-</span> existing[, <span class="fu">names</span>(row), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>      row <span class="ot">&lt;-</span> <span class="fu">rbind</span>(existing, row)</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(row, path, <span class="at">layer =</span> <span class="st">"greenspace"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>, <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a><span class="co">#' Read cached buffered DAs for (bbox, buffer_m). Returns sf with da_row and geometry (WGS84) or NULL.</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>get_cached_buffers <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, buffer_m, <span class="at">path =</span> CACHE_GPKG) {</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ensure_cache</span>(path)</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>  uid <span class="ot">&lt;-</span> <span class="fu">bbox_to_uid</span>(bbox)</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"da_buffers"</span> <span class="sc">%in%</span> <span class="fu">st_layers</span>(path)<span class="sc">$</span>name) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>  cached <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_read</span>(path, <span class="at">layer =</span> <span class="st">"da_buffers"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cached) <span class="sc">||</span> <span class="fu">nrow</span>(cached) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>  hit <span class="ot">&lt;-</span> cached[cached<span class="sc">$</span>bbox_uid <span class="sc">==</span> uid <span class="sc">&amp;</span> <span class="fu">as.integer</span>(cached<span class="sc">$</span>buffer_m) <span class="sc">==</span> <span class="fu">as.integer</span>(buffer_m), ]</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(hit) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Geometry column name can be "geom" when read from GeoPackage</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sf</span>(<span class="at">da_row =</span> hit<span class="sc">$</span>da_row, <span class="at">geometry =</span> <span class="fu">st_geometry</span>(hit), <span class="at">crs =</span> <span class="fu">st_crs</span>(cached))</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a><span class="co">#' Write buffered DAs to cache. buffers_sf must have ._da_row and geometry (any CRS; stored as WGS84).</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>set_cached_buffers <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, buffer_m, buffers_sf, <span class="at">city =</span> <span class="cn">NULL</span>, <span class="at">path =</span> CACHE_GPKG) {</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"._da_row"</span> <span class="sc">%in%</span> <span class="fu">names</span>(buffers_sf)) <span class="fu">stop</span>(<span class="st">"buffers_sf must have ._da_row"</span>)</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ensure_cache</span>(path)</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>  uid <span class="ot">&lt;-</span> <span class="fu">bbox_to_uid</span>(bbox)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>  buf <span class="ot">&lt;-</span> buffers_sf <span class="sc">%&gt;%</span> <span class="fu">select</span>(._da_row)</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>  buf<span class="sc">$</span>bbox_uid <span class="ot">&lt;-</span> uid</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>  buf<span class="sc">$</span>buffer_m <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(buffer_m)</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>  buf<span class="sc">$</span>city <span class="ot">&lt;-</span> <span class="fu">as.character</span>(city <span class="sc">%||%</span> <span class="cn">NA_character_</span>)</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>  buf<span class="sc">$</span>fetched_at <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>)</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>  buf <span class="ot">&lt;-</span> buf <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">da_row =</span> ._da_row)</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>  buf <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(buf, <span class="dv">4326</span>)</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">attr</span>(buf, <span class="st">"sf_column"</span>) <span class="sc">!=</span> <span class="st">"geometry"</span>) {</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(buf)[<span class="fu">names</span>(buf) <span class="sc">==</span> <span class="fu">attr</span>(buf, <span class="st">"sf_column"</span>)] <span class="ot">&lt;-</span> <span class="st">"geometry"</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attr</span>(buf, <span class="st">"sf_column"</span>) <span class="ot">&lt;-</span> <span class="st">"geometry"</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>  existing <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">st_read</span>(path, <span class="at">layer =</span> <span class="st">"da_buffers"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(existing) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(existing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>    existing <span class="ot">&lt;-</span> existing[<span class="sc">!</span>(existing<span class="sc">$</span>bbox_uid <span class="sc">==</span> uid <span class="sc">&amp;</span> <span class="fu">as.integer</span>(existing<span class="sc">$</span>buffer_m) <span class="sc">==</span> <span class="fu">as.integer</span>(buffer_m)), ]</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(existing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>      geom_col <span class="ot">&lt;-</span> <span class="fu">attr</span>(existing, <span class="st">"sf_column"</span>)</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (geom_col <span class="sc">!=</span> <span class="st">"geometry"</span>) {</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(existing)[<span class="fu">names</span>(existing) <span class="sc">==</span> geom_col] <span class="ot">&lt;-</span> <span class="st">"geometry"</span></span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>        <span class="fu">attr</span>(existing, <span class="st">"sf_column"</span>) <span class="ot">&lt;-</span> <span class="st">"geometry"</span></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>      common <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(existing), <span class="fu">names</span>(buf))</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>      existing <span class="ot">&lt;-</span> existing[, common, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>      buf <span class="ot">&lt;-</span> buf[, common, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>      buf <span class="ot">&lt;-</span> <span class="fu">rbind</span>(existing, buf)</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(buf, path, <span class="at">layer =</span> <span class="st">"da_buffers"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>, <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a><span class="co">#' Read cached clipped income layer for a bbox. Returns sf (WGS84) or NULL if miss.</span></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>get_cached_clipped_income <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, <span class="at">path =</span> CACHE_GPKG) {</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ensure_cache</span>(path)</span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>  uid <span class="ot">&lt;-</span> <span class="fu">bbox_to_uid</span>(bbox)</span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"clipped_income"</span> <span class="sc">%in%</span> <span class="fu">st_layers</span>(path)<span class="sc">$</span>name) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>  cached <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_read</span>(path, <span class="at">layer =</span> <span class="st">"clipped_income"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(cached) <span class="sc">||</span> <span class="fu">nrow</span>(cached) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>  hit <span class="ot">&lt;-</span> cached[cached<span class="sc">$</span>bbox_uid <span class="sc">==</span> uid, ]</span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(hit) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>  hit<span class="sc">$</span>bbox_uid <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>  hit</span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a><span class="co">#' Write clipped income layer to cache (keyed by bbox UID). clipped_sf: output of st_intersection with bbox.</span></span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>set_cached_clipped_income <span class="ot">&lt;-</span> <span class="cf">function</span>(bbox, clipped_sf, <span class="at">path =</span> CACHE_GPKG) {</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ensure_cache</span>(path)</span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>  uid <span class="ot">&lt;-</span> <span class="fu">bbox_to_uid</span>(bbox)</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>  clipped_sf<span class="sc">$</span>bbox_uid <span class="ot">&lt;-</span> uid</span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>  existing <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"clipped_income"</span> <span class="sc">%in%</span> <span class="fu">st_layers</span>(path)<span class="sc">$</span>name) {</span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>    existing <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_read</span>(path, <span class="at">layer =</span> <span class="st">"clipped_income"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(existing) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(existing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a>    existing <span class="ot">&lt;-</span> existing[existing<span class="sc">$</span>bbox_uid <span class="sc">!=</span> uid, ]</span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(existing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a>      geom_col <span class="ot">&lt;-</span> <span class="fu">attr</span>(existing, <span class="st">"sf_column"</span>)</span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a>      target_geom <span class="ot">&lt;-</span> <span class="fu">attr</span>(clipped_sf, <span class="st">"sf_column"</span>)</span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (geom_col <span class="sc">!=</span> target_geom) {</span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(existing)[<span class="fu">names</span>(existing) <span class="sc">==</span> geom_col] <span class="ot">&lt;-</span> target_geom</span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a>        <span class="fu">attr</span>(existing, <span class="st">"sf_column"</span>) <span class="ot">&lt;-</span> target_geom</span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a>      existing <span class="ot">&lt;-</span> existing[, <span class="fu">names</span>(clipped_sf), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a>      clipped_sf <span class="ot">&lt;-</span> <span class="fu">rbind</span>(existing, clipped_sf)</span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(clipped_sf, path, <span class="at">layer =</span> <span class="st">"clipped_income"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>, <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple %||% for optional default</span></span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%||%</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) <span class="cf">if</span> (<span class="fu">is.null</span>(x)) y <span class="cf">else</span> x</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p>See the <a href="../../projects/Leaflet_Mapping_Tool/guide.html">Guide</a> in this project for setup and how to run the tool.</p>
</section>
</div>
<script>
(function() {
  var productPanel = document.getElementById('yoga-final-product');
  var overviewPanel = document.getElementById('yoga-overview');
  var scriptsPanel = document.getElementById('yoga-scripts');
  var btnProduct = document.querySelector('.yoga-btn-product');
  var btnOverview = document.querySelector('.yoga-btn-overview');
  var btnScripts = document.querySelector('.yoga-btn-scripts');
  if (!productPanel || !overviewPanel || !scriptsPanel || !btnProduct || !btnOverview || !btnScripts) return;

  function setActive(btn) {
    [btnProduct, btnOverview, btnScripts].forEach(function(b) {
      b.classList.remove('btn-primary');
      b.classList.add('btn-outline-primary');
      b.setAttribute('aria-pressed', 'false');
    });
    btn.classList.add('btn-primary');
    btn.classList.remove('btn-outline-primary');
    btn.setAttribute('aria-pressed', 'true');
  }
  function showProduct() {
    productPanel.classList.remove('d-none');
    overviewPanel.classList.add('d-none');
    scriptsPanel.classList.add('d-none');
    setActive(btnProduct);
  }
  function showOverview() {
    productPanel.classList.add('d-none');
    overviewPanel.classList.remove('d-none');
    scriptsPanel.classList.add('d-none');
    setActive(btnOverview);
  }
  function showScripts() {
    productPanel.classList.add('d-none');
    overviewPanel.classList.add('d-none');
    scriptsPanel.classList.remove('d-none');
    setActive(btnScripts);
  }

  btnProduct.addEventListener('click', showProduct);
  btnOverview.addEventListener('click', showOverview);
  btnScripts.addEventListener('click', showScripts);

  // Fill right margin "On this page" TOC (Quarto leaves it empty for sidebar pages)
  function buildMarginTOC() {
    if (!document.body.classList.contains('yoga-project-page')) return;
    var marginSidebar = document.getElementById('quarto-margin-sidebar');
    if (!marginSidebar || marginSidebar.querySelector('#TOC')) return;
    var main = document.getElementById('quarto-document-content');
    if (!main) return;
    var headings = main.querySelectorAll('h2.anchored[data-anchor-id]');
    if (headings.length === 0) return;
    var nav = document.createElement('nav');
    nav.id = 'TOC';
    nav.setAttribute('role', 'doc-toc');
    nav.className = 'toc-active';
    var title = document.createElement('h2');
    title.id = 'toc-title';
    title.textContent = 'On this page';
    nav.appendChild(title);
    var ul = document.createElement('ul');
    ul.className = 'collapse';
    headings.forEach(function(h2) {
      var id = h2.getAttribute('data-anchor-id') || h2.id;
      if (!id) return;
      var li = document.createElement('li');
      var a = document.createElement('a');
      a.href = '#' + id;
      a.id = 'toc-' + id;
      a.className = 'nav-link';
      a.setAttribute('data-scroll-target', '#' + id);
      a.textContent = h2.textContent.trim();
      li.appendChild(a);
      ul.appendChild(li);
    });
    nav.appendChild(ul);
    marginSidebar.appendChild(nav);
    document.querySelectorAll('#TOC a[data-scroll-target]').forEach(function(link) {
      link.addEventListener('click', function(e) {
        var id = link.getAttribute('data-scroll-target');
        if (!id) return;
        var target = document.querySelector(id);
        if (!target) return;
        if (overviewPanel.contains(target)) {
          e.preventDefault();
          showOverview();
          requestAnimationFrame(function() { target.scrollIntoView({ behavior: 'smooth' }); });
        } else if (scriptsPanel.contains(target)) {
          e.preventDefault();
          showScripts();
          requestAnimationFrame(function() { target.scrollIntoView({ behavior: 'smooth' }); });
        }
      });
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', buildMarginTOC);
  } else {
    buildMarginTOC();
  }
})();
</script>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mackaykp\.github\.io\/kevin-mackay-phd");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2026 Kevin Mackay, PhD</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with Quarto</p>
</div>
  </div>
</footer>




</body></html>